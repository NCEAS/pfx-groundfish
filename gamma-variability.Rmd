---
title: "Local vs Regional Stability of Gulf of Alaksa Groundfish Assemblages"
author: "Colette Ward"
date: "July 12, 2016"
output: pdf_document
---


```{r, include=FALSE, echo=FALSE, results='hide'}
# Load packages
library(httr)
library(plyr)
library(dplyr)
library(tidyr)
library(ggplot2)

```


```{r,  include=FALSE, echo=FALSE, results='hide'}
# load & prep look-up table of common names
URL_common <- "https://drive.google.com/uc?export=download&id=0B1XbkXxdfD7ubzIzdURzanhfZnc" # this is "trawl_species_control_file.csv"
common_Get <- GET(URL_common)
common_1 <- content(common_Get, as='text')
common <- read.csv(file=textConnection(common_1),stringsAsFactors=FALSE,head=TRUE)

common1 <- common %>%
  select(database.name, common.name) %>%
  rename(Species = database.name)
for (i in 1:nrow(common1)) { # add common names for Sebastes 1 & 2
  if(common1$Species[i] == "Dusky.and.Dark.Rockfish") {common1$common.name[i] <- "Sebastes 1"}
  if(common1$Species[i] == "Rougheye.and.Blackspotted.Rockfish") {common1$common.name[i] <- "Sebastes 2"}
}
```


```{r,  include=FALSE, echo=FALSE, results='hide'}
# load mean annual CPUE data for Shallow Areas:
URL_shallowCPUEArea <- "https://drive.google.com/uc?export=download&id=0By1iaulIAI-uYzBOUFRtZklmX0U" # new data for shallow areas
shallowCPUEArea_Get <- GET(URL_shallowCPUEArea)
shallowCPUEArea_1 <- content(shallowCPUEArea_Get, as='text')
shallowCPUEArea <- read.csv(file=textConnection(shallowCPUEArea_1),stringsAsFactors=FALSE,head=TRUE)
#View(shallowCPUEArea)

shallowCPUEArea2 <- left_join(shallowCPUEArea, common1, by = "Species") %>% # merge common names onto SPCPUEArea
  select(area, Mean.totalDensity, SD.totalDensity, year, Species, common.name)

```

```{r,  include=FALSE, echo=FALSE, results='hide'}
# load mean annual CPUE for Deep areas:
URL_deepCPUEArea <- "https://drive.google.com/uc?export=download&id=0By1iaulIAI-uVF9VWnNPX3Z3S3c"
deepCPUEArea_Get <- GET(URL_deepCPUEArea)
deepCPUEArea_1 <- content(deepCPUEArea_Get, as='text')
deepCPUEArea <- read.csv(file=textConnection(deepCPUEArea_1),stringsAsFactors=FALSE,head=TRUE)
#View(deepCPUEArea)

deepCPUEArea2 <- left_join(deepCPUEArea, common1, by = "Species") %>% # merge in common names
  select(area, Mean.totalDensity, SD.totalDensity, year, Species, common.name)

```

To address regional vs local community stability we can compare CVs of total CPUE between local communities and the regional metacommunity.
The regional community does indeed show greater stability than local communities:
(If anyone wants to make this plot prettier, please do :) )

```{r, echo=F, fig.height=3, fig.width=4}

CV <- shallowCPUEArea2 %>% 
  group_by(area, year) %>%
  summarise(total = sum(Mean.totalDensity)) %>%
  ungroup() %>%
  
  group_by(area) %>%
  summarise(CV = sd(total) / mean(total)) %>%
  ungroup()


# plot on a log scale
CV_plot <- ggplot(data=CV, aes(x=area, y = CV)) + 
  geom_point(aes(y = CV), size=3) +
  
  theme(panel.background = element_blank(),
        axis.line.x = element_line(color="black"),
        axis.line.y = element_line(color="black")) +
  
  scale_y_log10(breaks = c(0.07, 0.08, 0.09, 0.1, 0.2)) + # how do I put minor tick marks on the y axis?
  
  labs(x = "Area", y = "CV (Total CPUE)")

CV_plot


```

Although we can compare local and regional community stability using CVs alone, here we calculate metrics from Wang & Loreau (2014) to help us think about mechanisms underlying this result.
The following uses formulas from Wang & Loreau's (2014) Supp Mat (i.e. for varying biomass within and between local communities).
```{r,  include=FALSE, echo=FALSE, results='hide'}

# Calculate gamma variability

# SHOULD SPECIES CPUES BE LOG-TRANSFORMED FIRST???


# i = local area (patch) i
# j, k, l = species j, k, l
# i_j = species j in local area (patch) i

A_list <- list()
B_list <- list()
C_list <- list()
D_list <- list()
covMatrix_i_list <- list()
w_kk_i_list <- list()
E_list <- list()
F_list <- list()
rho_species_i_list <- list()
CV_i_list <- list()


shallowAreas_list <- split(shallowCPUEArea2, f = shallowCPUEArea2$area) # create a list of dataframes (one df for each local area & total region)
shallowAreas_list[[10]] <- NULL  # remove the 10th element from the list (remove the list for the total regional metacommunity)


for(i in seq_along(shallowAreas_list)) { # remove list for i = 10
  
  #############
  # 1. Calculate averaged species variability (C_list[[i]]$CV_species_i_squared):
  
  # calculate patch-level stuff
  A_list[[i]] <- shallowAreas_list[[i]] %>%
    summarise(u_i = mean(Mean.totalDensity)) # mean total community biomass (across all years) for local patch i
    
  
  # calculate species-level stuff
  B_list[[i]] <- shallowAreas_list[[i]] %>%
    group_by(Species) %>%
    summarise(u_j_i = mean(Mean.totalDensity), # mean biomass (across all years) of species j in patch i
              CV_j_i_squared = var(Mean.totalDensity) / (u_j_i)^2 , # CV of species j in patch i. Note that the usual formula for CV is squared here.
              CV_species_j_i = u_j_i / A_list[[i]]$u_i * CV_j_i_squared) %>% # CV of all species in patch i
    ungroup()
  
  
  # calculate averaged species variability
  C_list[[i]] <- B_list[[i]] %>%
    summarise(CV_species_i_squared = sum(CV_species_j_i))
  
  
  ###############
  # 2. Calculate species asynchrony WITHIN patches (rho_species_i_list[[i]]):
  
  D_list[[i]] <- shallowAreas_list[[i]] %>% # clean the data
    select(year, Mean.totalDensity, Species) %>%
    spread(Species, Mean.totalDensity) %>%
    select(-year)
  
  
  covMatrix_i_list[[i]] <- cov(D_list[[i]]) # create the covariance matrix
    
  
  w_kk_i_list[[i]] <- diag(covMatrix_i_list[[i]]) # extract diagonals of the covariance matrix. returns a vector. note cannot use mutate on a matrix
  
  
  covMatrix_i_list[[i]][upper.tri(covMatrix_i_list[[i]], diag = TRUE)] <- NA # for each patch i, keep one copy of all the non-diagonals. these are w_kl_i 
  E_list[[i]] <- as.data.frame(covMatrix_i_list[[i]])
  
  
  F_list[[i]] <- E_list[[i]] %>%
    summarise(sum_w_kl_i = sum(E_list[[i]][,1:53], na.rm = T)) # for each local patch i, find the sum of all w_kl_i. calc has been checked

  
  rho_species_i_list[[i]] <- F_list[[i]]$sum_w_kl_i / ((sum(sqrt(w_kk_i_list[[i]][1:53])))^2)
  
  
  ###############
  # 3. Calculate Variability of local community i (CV_i_list[[i]])
  CV_i_list[[i]] <- (C_list[[i]]$CV_species_i_squared * rho_species_i_list[[i]])^2 # SHOULD THIS BE SQUARED? If not squred, returns a negative value when within-patch species synchrony is negative
      
  # CHECK WHETHER LOCAL COMMUNITY VARIABILITY CORRELATES WITH SIZE (AREA) OF LOCAL COMMUNITY (IE DO LARGER AREAS SHOW MORE VARIABILITY?)
  
  
  ###############
  # 4. Calculate Alpha variability (local community variability weighed for local community biomass; alpha_CV_list[[i]])
  u_m <- sum(A_list[[i]]$u_i)
  alpha_CV <- (sum(A_list[[i]]$u_i / u_m * CV_i_list[[i]] ))^2 # alpha_CV = 0.004474226

  
  ###############
  # 5. Calculate Beta variability (spatial synchrony; rho)
  #rho <- 
  
  
}  
```

```{r}
alpha_CV

CV_i_list


```