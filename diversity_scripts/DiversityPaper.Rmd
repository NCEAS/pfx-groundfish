---
title: 'Diversity Paper: THIS NEEDS A CATCHY TITLE!'
output:
  html_document: default
  fig_height: 4
  fig_width: 7
  fig_caption: yes
  pdf_document: null
date: "May 3, 2016"
---

##Introduction

The effects of community diversity on ecosystem stability and the mechanisms structuring communities remain important topics of ecological study. The insurance hypothesis (Yachi & Loreau 1999) states that ...must set up the diversity - stability thing here......led to the description of the portfolio effect.    

The portfolio effect, essentially statistical averaging, is one explanation for stability in multi-species communities.  This effect occurs when species have asynchronous responses to environmental perturbations, but when summed across the community the responses average out statistically leading to increased stability with increased diversity (Cotthingham et al 2001, Doak et al 1998).  This effect can be conveyed through the mechanisms of species' intrinsic responses, the speed of those responses, and a reduction in interspecific competition (Yachi & Loreau 1999, Loreau & de Mazancourt 2013).      

While numerous theories have been advanced to explain patterns of community composition, no single unifying construct seems adequate to explain observed patterns of species co-existence (Wilson 2011). Much of the previous work on mechanisms governing community composition occurred in terrestrial systems where factors governing species co-existence could be carefully controlled, monitored, and compared. In marine systems identifying opportunities for comparative studies is more difficult  and thus there are fewer studies comparing patterns and mechanisms of differences in community composition in the oceans (Smith et al. 1993).  



Recent studies have suggested that response redundancy can lead to improved stability of ecosystem functions within marine ecosystems ?????through alternative pathways for stability (Schindler et al. 2015; Schindler et al. 2010)?????.

The mechanisms underlying the portfolio effect intersect with community composition effects through redundancy, structure,????? and the interaction terms?????.  If these concepts do have a stabilizing effect, we hypothesize that portfolios would be preserved across space (ecoregions) within large marine ecosystems that have similar large scale environmental forcing.  We further hypothesize that if portfolios are preserved across space within large marine ecosystems (LMEs) with similar environmental exposure, then similar suites of species would be found within ecoregions.



Boreal marine systems such as the Gulf of Alaska (GOA) experience high levels of seasonal, interannual, decadal and multi-decadal variability which in turn impact marine species (Anderson and Piatt 1999; Hare and Mantua 2000; Hollowed et al. 2001; Stachura et al. 2014).  These climate driven perturbations create states of non-equilibrium at multiple spatial scales.  The GOA provides an excellent region to examine mechanisms governing community composition and the portfolio effect.  The region exhibits complex topography being punctuated by submarine troughs and canyons which act to steer currents (Lagerloef 1983).  Previous studies have utilized this complex topography for natural experiments based on the comparison of responses of selected fish species to natural or anthropogenic disturbance (Hollowed et al. 2007; Logerwell et al. 2007; Walline et al. 2012). 

We focused our study on examining the portfolio effect on ecosystem responses to natural (e.g., regime shifts (Anderson and Piatt 1999)) and anthropogenic (e.g., the Exxon Valdez Oil Spill (EVOS) (Incardona et al. 2015)) environmental perturbations.  We tested species responses through time and functional complementarity, two mechanisms of the portfolio effect (Loreau & de Mazancourt 2013).  

We also reviewed three of the most promising of the 12 hypotheses governing species co-existence which were reviewed by Wilson (2011):

1. Alpha-niche differentiation – stabilizing
2. Environmental fluctuation – stabilizing [ via relative non-linearity and/or the storage effect see (Chesson 2004)]
3. Allogenic disturbance – stabilizing [intermediate disturbance; although climate variability occurs on large spatial scales, fishing occurs at intermediate scales, therefore this hypothesis is retained here]

We then extended single species studies to explore the evidence for community stability and commonality in regional species portfolios as measured by common members of species complexes, and stability in species diversity.  It is unclear which of the potential ecosystem disturbances: environmental variability, fishing, and predation (Gaichas et al. 2011).  We expect that explorations of these relationships on a regional basis will elucidate key processes underlying GOA ecosystems.   

## Methods
### Trawl Survey
Since 1984, the Alaska Fisheries Science Center (AFSC) has conducted comprehensive bottom trawl surveys in the GOA to monitor trends in the distribution and abundance of groundfish populations. The full survey area includes the continental shelf and upper continental slope (to 1,000 m depth) in the GOA and extends from the Islands of Four Mountains (170° W) 2,300 km east to Dixon Entrance (54° N). The AFSC contracts 3 commercial trawlers during May–August and samples the standard 320,000 km2 survey area with approximately 820 survey stations. The catch data result in observations of catch-per-unit-area (CPUE) which are averaged and expanded by survey area to estimate the relative abundance of important groundfish species.  This multi-species survey is based upon a stratified-random design and the area-swept method of estimating abundance (von Szalay et al. 2010 ). 

The net used in this survey is a four-seam, high-opening Poly Nor’Eastern trawl featuring a 27.2 m headrope and a 36.7 m footrope equipped with rubber bobbin roller gear. The net is deployed from the vessel while the vessel steams ahead at 3 knots.  Once on the seafloor, the net is towed for 30 minutes (prior to 1992) or 15 minutes (1992 - present).  In most years the net was equipped with a bottom contact sensor on the footrope, and a Seabird SBE-39 bathythermograph on the headrope. The catch was processed by the scientific crew who identified all living organisms, weighed and counted the catch of each species, and took biological samples (lengths, otoliths, and specially requested tissues) from key groundfish species or other species of interest. 

### Study Areas
We mapped the areas covered by the trawl survey data as well as the extent of the EVOS over the shelf region of the central GOA.  We then selected study areas on the shelf across a gradient of oil exposure and based on bottom depth: 9 contiguous areas of depth 50 - 150 m, 5 contiguous areas of 151 - 300 m (Figure 1).  Study areas ranged in size from xxx – yyy km2, and were located from XXXX degrees W to XXXXX degrees W.  This provided us with study areas that were East of the spill and did not receive oil, at the same longitude as the spill and likely were oiled, and areas West of the spill extent that were also likely unoiled.  

### Modeling
AFSC survey data were smoothed using a geostatistical model developed by (Ono et al. 2015; Shelton et al. 2014).  The model treated year and depth as fixed effects on CPUE.  Most groundfish exhibit spatial partitions related to depth (CITATION NEEDED).  In addition many groundfish also exhibit notable ontogenetic shifts in depth (CITATION).  Including depth as a fixed effect corrects for species specific affinities for a given depth range.  To correct for ontogenetic shifts in depth, the depth and temperature distributions were examined by length category for species that had continuous time series of length measurements.    

The estimated range at which the spatial correlation in the spatial field falls to 0.05 after accounting for depth ranged from 10km – 500km with most species exhibiting a range of 65km.  Species with higher frequencies of occurrence tended to have lower spatial ranges with the dominant species (cod, halibut, sablefish, and pollock) being less than 60km.  Area expansions derived from the model were used to estimate abundance for each of the 9 sub-regions.  Some information is shared between regions due to the the spatial range of correlations, however in most species/region cases the distances between the 9 regions exceeded the species range.  For each of the nine regions the mean and variance of biomass by species was calculated.  It should be noted that the species exhibit different vulnerability to the survey trawl.  Thus, all results reflect the demersal shelf fish community.

### Statistical Analysis
Stability = temporal stability in this case. Stability over the 32 years of the study. 

Alpha (within study area) and beta (between study areas) components of diversity were estimated based on (Jost 2007). Components of species diversity were derived from estimated mean biomass for each species within a region.  To correct for uncertainty in regional abundance we resampled the expected distribution of species within each region 1000 times using bootstrap methods. 

To evaluate regional differences in ecosystem structure we partitioned the predicted mean biomass for a given species into functional groups using based on the NMFS food-habits database (xxxx).  For each ecoregion the mean density for each region was plotted and the biomass in each trophic guild was estimated (Table 2, Figure 2) for the entire time series 1984 – present.  


## Results
### Environmental Conditions and species/community responses across study areas and through time: 
The mean depth and bottom temperature of each region is shown in Table 1.  
EVOS extent (cite Figure 1, the map).
Other larger perturbations, regime shifts, etc, during the study time (1984 - 2015).
Response of species and communities (cite Figure 2).

### Diversity within and between study areas (both species and functional diversity/complementarity)
Alpha diversity for shallow and deep (cite Figure 3).
Beta diversity for shallow and deep (cite Figure 4).
Functional diversity for shallow and deep (cite Figure 5).  

### Community composition
Compare composition between all shallow areas and all deep areas (over time?) (cite Figure 6).  






### Figures: 


```{r, include=FALSE, echo=FALSE, results='hide'}
# Load all necessary packages
library(plyr) ; library(dplyr); library(tidyr) ; library(stringr) ; 
library(sp) ; library(maptools) ; library(raster) ; library(ggplot2) ; 
library(maps) ; library(mapdata) ; library(mapproj) ; library(httr) ; library(extrafont) ; 
library(vegan) ; library(scales)
```

```{r loadMapData, message=FALSE, echo=FALSE, warning=FALSE}
# Map of area locations
discrete_ShallowAreas <- read.csv("./goaTrawl/Output Data/Shallow_goa_discrete_areas_for_comparison_Combined(50_to_150m).MH.csv")
discrete_DeepAreas <- read.csv("./goaTrawl/Output Data/Deep_goa_discrete_areas_for_comparison_150_to_300m.MH.csv")
```

1: Map of shallow and deep study areas overlaid with EVOS slick  
```{r map, cache=FALSE, echo=FALSE, warning=FALSE}
    ak <- map_data('worldHires','USA:Alaska')
    akmap <- ggplot()+geom_polygon(data=ak,aes(long,lat,group=group),fill=8,color="black") +
             theme(panel.background=element_rect(fill='aliceblue')) +
             xlab(expression(paste(Longitude^o,~'W'))) +
             ylab(expression(paste(Latitude^o,~'N'))) +
             coord_map(xlim = c(-160, -143),ylim = c(54, 61))
```

```{r, fig.cap="Locations of shallow areas (50-150 m) in Gulf of Alaska.",fig.pos="placehere",echo=FALSE,fig.height=4, fig.width=7}
#map of Shallow locations
discrete_ShallowAreas$area <- discrete_ShallowAreas$Area
discrete_ShallowAreas$Area <- factor(discrete_ShallowAreas$area)

akmap + geom_point(data=discrete_ShallowAreas,aes(LONGITUDE,LATITUDE,color=Area))
```

```{r, fig.cap="Locations of deep areas (>150-300 m) in Gulf of Alaska.",fig.pos="placehere",echo=FALSE,fig.height=4, fig.width=7}
#map of Deep locations
discrete_DeepAreas$area <- discrete_DeepAreas$Area
discrete_DeepAreas$Area <- factor(discrete_DeepAreas$area)

akmap + geom_point(data=discrete_DeepAreas,aes(LONGITUDE,LATITUDE,color=Area))
```

```{r,  include=FALSE, echo=FALSE, results='hide'}
# Load the Species by Area Occurrance data and clean it
URL_SpByArea <- "https://drive.google.com/uc?export=download&id=0By1iaulIAI-uOGwySlN0T3NUQUE"
SpByArea_Get <- GET(URL_SpByArea)
SpByArea_1 <- content(SpByArea_Get, as='text')
SpByArea <- read.csv(file=textConnection(SpByArea_1), stringsAsFactors=FALSE, header=TRUE)


meanOcc <- SpByArea %>%
  mutate(Year = ifelse((year.numb=="1"),'1984',
                ifelse((year.numb=="2"),'1987',
                ifelse((year.numb=="3"),'1990',
                ifelse((year.numb=="4"),'1993',       
                ifelse((year.numb=="5"),'1996',
                ifelse((year.numb=="6"),'1999',
                ifelse((year.numb=="7"),'2001',
                ifelse((year.numb=="8"),'2003',
                ifelse((year.numb=="9"),'2005',
                ifelse((year.numb=="10"),'2007',
                ifelse((year.numb=="11"),'2009',
                ifelse((year.numb=="12"),'2011',
                ifelse((year.numb=="13"),'2013',
                ifelse((year.numb=="14"),'2015',        
                ""))))))))))))))
        )


```

```{r,  include=FALSE, echo=FALSE, results='hide'}
# Load the CPUE by Area data and merge in trawl species list
URL_SPCPUEArea <- "https://drive.google.com/uc?export=download&id=0By1iaulIAI-uYzBOUFRtZklmX0U"
SPCPUEArea_Get <- GET(URL_SPCPUEArea)
SPCPUEArea_1 <- content(SPCPUEArea_Get, as='text')
SPCPUEArea <- read.csv(file=textConnection(SPCPUEArea_1), stringsAsFactors=FALSE, header=TRUE)

meanCPUE <- rename(SPCPUEArea, Year=year, Area=area)


```

```{r, include=FALSE, echo=FALSE, results='hide'}
# Read in deeper areas data CPUE
URL_deepCPUE <- "https://drive.google.com/uc?export=download&id=0By1iaulIAI-uVF9VWnNPX3Z3S3c"
deepCPUE_Get <- GET(URL_deepCPUE)
deepCPUE_1 <- content(deepCPUE_Get, as='text')
deepCPUE <- read.csv(file=textConnection(deepCPUE_1),stringsAsFactors=FALSE,head=TRUE)

deepCPUE <- rename(deepCPUE, Year=year, Area=area)

```

```{r, include=FALSE, echo=FALSE, results='hide'}
# Read in deeper areas data OCCURRANCE
URL_deepOCC <- "https://drive.google.com/uc?export=download&id=0By1iaulIAI-uZG1LbkphNmFpQ28"
deepOCC_Get <- GET(URL_deepOCC)
deepOCC_1 <- content(deepOCC_Get, as='text')
deepOCC_2 <- read.csv(file=textConnection(deepOCC_1),stringsAsFactors=FALSE,head=TRUE)


deepOCC <- deepOCC_2 %>%
  mutate(Year = ifelse((year.numb=="1"),'1984',
                ifelse((year.numb=="2"),'1987',
                ifelse((year.numb=="3"),'1990',
                ifelse((year.numb=="4"),'1993',       
                ifelse((year.numb=="5"),'1996',
                ifelse((year.numb=="6"),'1999',
                ifelse((year.numb=="7"),'2001',
                ifelse((year.numb=="8"),'2003',
                ifelse((year.numb=="9"),'2005',
                ifelse((year.numb=="10"),'2007',
                ifelse((year.numb=="11"),'2009',
                ifelse((year.numb=="12"),'2011',
                ifelse((year.numb=="13"),'2013',
                ifelse((year.numb=="14"),'2015',        
                ""))))))))))))))
        )


```

```{r, echo=FALSE}
# Make custom theme for plotting
theme_boxplot <- function(base_size = 12){
                 theme_bw(base_size)%+replace%
                 theme(legend.key.size=unit(12,"points"),
                 legend.text=element_text(size=11),
                 legend.key=element_blank(),
                 legend.title=element_blank(),
                 legend.background=element_rect(colour="white", fill="transparent"),
                 plot.margin=unit(c(0.5,1,0.5,1), "lines"),  
                 panel.border=element_blank(),
                 panel.margin=unit(0,"lines"),
                 panel.background=element_rect(fill=NA, colour=NA),
                 panel.grid.major=element_blank(),
                 panel.grid.minor=element_blank(),
                 axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'),
                 axis.line.y = element_line(colour = 'black', size=0.5, linetype='solid'),
                 axis.ticks.length=unit(1,"mm"),
                 axis.text.x = element_text(margin=margin(5,0,0,0), size=12), 
                 axis.text.y = element_text(margin=margin(0,5,0,0), size=12),
                 axis.title.x=element_text(size=12, margin=margin(15,0,0,0)),
                 axis.title.y=element_text(size=12, angle=90, margin=margin(0,15,0,0)),
                 strip.text.x=element_text(size=12),
                 strip.background=element_rect(colour="black", fill='white'))
                 }



```

```{r, include=FALSE, echo=FALSE}
# Functions to create plots
weight.var <- function(w){
  return(sum(w)^(-1))
}

space_plot <- function(df,NAME){
  par(mfrow=c(3,2),mar=c(3,4,1,0.5))
  AT <- df$Area  
  
  plot(1:5,1:5,type="n",axes=F,xlab="",ylab="")
  #text(1.5,4,NAME,cex=3,pos=4)
  y.lim <- c(min(df$Trend - df$SE.trend),max(df$Trend + df$SE.trend))
  plot(Trend~Area,data=df,ylim=y.lim,axes=F,pch=21,bg=1)
  abline(h=0,lty=2)
  arrows(x0=df$Area,x1=df$Area,
         y0=df$Trend + df$SE,y1= df$Trend - df$SE,
         length=0,lwd=1.5)
  axis(1,at=AT); box(bty="o")
  axis(2,las=2)
  title(xlab="Area",line=2)
  
  # B <- plot(Grand.w.mean~Area,data=df,type="b",axes=F,xlab="",pch=21,bg=1)
  #    axis(1,at=AT); box(bty="o")
  #    axis(2,las=2)
  #    title(xlab="Area",line=2)
  
  plot(SD~Area,data=df,type="b",axes=F,
       ylim= c(0,max(df$SD)),xlab="",pch=21,bg=1)
  axis(1,at=AT); box(bty="o")
  axis(2,las=2)
  title(xlab="Area",line=2)
  
  plot(CV~Area,data=df,type="b",axes=F,xlab="",pch=21,bg=1)
  axis(1,at=AT); box(bty="o")
  axis(2,las=2)
  title(xlab="Area",line=2)
  
  # E <- plot(Var~Grand.w.mean,data=df,axes=F,xlab="",pch=21,bg=1)
  #    axis(1); box(bty="o")
  #    axis(2,las=2)
  #    title(xlab="W.mean",line=2)
  
  # G <- c(A,C,D)
  
  return()
  
}



time_plot <- function(df,NAME){
  AREA <- as.numeric(as.character(unique(df$Area)))
  YEAR <- sort(unique(df$Year))
  y.lim <- c(min(df$Mean.totalDensity),max(df$Mean.totalDensity))
  
  for(i in 1:length(AREA)){
    if(AREA[i] !=1){par(new=T)}
    if(AREA[i] >= 3 & AREA[i] <= 5 ){
      plot(Mean.totalDensity~Year,data=df[df$Area ==AREA[i],],
           type="l",axes=F,xlab="",ylim=y.lim,col=2,lwd=2,ylab="")
    }
    
    if(AREA[i] < 3 | AREA[i] > 5){
      plot(Mean.totalDensity~Year,data=df[df$Area ==AREA[i],],
           type="l",axes=F,xlab="",ylim=y.lim,col=1,lwd=1.5,ylab="")
    }
  }
  
  axis(1,at=YEAR,las=1,hadj=0.6,tcl=-0.25)
  axis(2,las=2,hadj=0.5,tcl=-0.25)
  box(bty="l",lwd=2)
  #title(ylab=expression("Biomass (kg ha"^"-1"*")"),line=2.5)
  mtext(NAME,adj=0.05,line=-1)
  #abline(v=1989,lty=2,lwd=2)
  arrows(x0=1989,x1=1989,y0=y.lim[1],y1=y.lim[1]+
           c(y.lim[2]-y.lim[1])*0.8,length=0,lty=2,lwd=2)
}

##########
# Calculate least squares trend in each area and portfolio metrics.

trend_calc <- function(df,y,x, plot_name){
  vals <- NULL
  
  for(j in 1:length(AREA)){
    A <- lm(y~x,data=df[df$Area == AREA[j] & df$Year > 1989,]) 
    B <- lm(y~1,data=df[df$Area == AREA[j] & df$Year > 1989,]) 
    vals <- rbind(vals,c(AREA[j],
                         coef(summary(A))["x",c("Estimate","Std. Error")],
                         coef(summary(B))[1,c("Estimate","Std. Error")],
                         var(A$residuals),
                         sd(A$residuals)))
  }
  
  vals <- data.frame(vals)
  colnames(vals) <- c("Area","Trend","SE.trend","Grand.w.mean",
                      "Grand.w.mean.se","Var","SD")
  vals$CV  <- vals$SD / vals$Grand.w.mean 
  
  df_2 <- vals
  
  C <- space_plot(df=df_2,NAME=plot_name)
  
  return(C)
}



#trend_calc(df=dat,y="SW_Div",x="Year", plot_name="Shannon Wiener")

#########

Plot_area_time <-function(df,y,ylabel){
  
  plot_1 <- ggplot(df, aes(x=Year, y=y, color=Area)) +
    geom_line(size=1) + theme_bw() + 
    ylab(ylabel) +
    geom_vline(aes(xintercept=1989), colour="black",
               linetype="dashed") +
    scale_color_manual(values=line_colors, 
                       breaks=area_breaks) + 
    scale_x_continuous(breaks=pretty_breaks(n=15)) + 
    theme(panel.grid=element_blank(), 
          legend.key=element_blank())
  
  return(plot_1)
} 


```

2: Response of species through time to events, 
      response of the community(ies) through time to events (Biomass)      
    
```{r, echo=FALSE}
# add total densities for plotting
meanCPUE_indiv <- meanCPUE %>%
                  filter(Area != "Total")

meanCPUE_tot <- meanCPUE %>%
                filter(Area == "Total") %>%
                group_by(Year) %>%              
                mutate(Yearly_Mn_Density = mean(Mean.totalDensity)) %>%
                ungroup()
                
head(data.frame(meanCPUE_tot))

deepCPUE_indiv <- deepCPUE %>%
                  filter(Area != "Total")

deepCPUE_tot <- deepCPUE %>%
                filter(Area == "Total") %>%
                group_by(Year) %>%
                mutate(Yearly_Mn_Density = mean(Mean.totalDensity)) %>%
                ungroup()

```

```{r, echo=FALSE, fig.height=4, fig.width=7,fig.cap="Community vs. Individual Taxon Variance for Shallow Areas"}

limits_vert <- factor(c("Total", "", "", "", (rev(levels(factor(meanCPUE_indiv$Species))))))
breaks_vert <- factor(c("Total", (rev(levels(factor(meanCPUE_indiv$Species))))))
labels_vert <- factor(c("Whole Community", rev((levels(factor(meanCPUE_indiv$Species))))))

ShlwPlot2 <- ggplot() + 
             geom_boxplot(data=meanCPUE_indiv, aes(x=Species, y=Mean.totalDensity)) +  
             theme_boxplot() + ylab("Mean Density") + xlab("Taxon") +  
             geom_boxplot(data=meanCPUE_tot, aes(x=Area, y=Yearly_Mn_Density), width=3) +
             scale_x_discrete(limits = limits_vert, breaks=breaks_vert, labels=labels_vert) +
             scale_y_continuous(expand = c(0, 0), limits = c(-2, 150)) +
             theme(axis.text.y = element_text(vjust=0.3, hjust=1, 
                                              size=ifelse(limits_vert=="Total",15,9),
                                              face=ifelse(limits_vert=="Total","bold","italic")))  + 
             coord_flip() 
ShlwPlot2

```

```{r, echo=FALSE, fig.height=4, fig.width=7,fig.cap="Community vs. Individual Taxon Variance for Deep Areas"}
DeepPlot <- ggplot() + 
            geom_boxplot(data=deepCPUE_indiv, aes(x=Species, y=Mean.totalDensity)) +
            theme_boxplot() + ylab("Mean Density") + xlab("Taxon") + 
            geom_boxplot(data=deepCPUE_tot, aes(x=Area, y=Yearly_Mn_Density), width=3) +
            scale_x_discrete(limits = limits_vert, breaks=breaks_vert, labels=labels_vert) +
            scale_y_continuous(expand = c(0, 0), limits = c(-2, 325)) +
            theme(axis.text.y = element_text(vjust=0.3, hjust=1, 
                                             size=ifelse(limits_vert=="Total",15,9),
                                             face=ifelse(limits_vert=="Total","bold","italic"))) + 
            coord_flip()
DeepPlot

```


```{r, echo=FALSE, include=FALSE}
## Data for 9 shallow areas
Div.Metrics<-read.csv("DiversityMetrics.Shallow.Bootstrapped.csv")
Div.Metrics<-Div.Metrics[Div.Metrics$AREA!=10,]
Sp.Richness<-read.csv("Sp.Richness.Shallow.Bootstrapped.csv")
Sp.Richness<-Sp.Richness[Sp.Richness$AREA!=10,]
shallowDat<-cbind(Div.Metrics,Sp.Richness)
shallowDat<-shallowDat[,c(1:6,10)]

## Data for 5 deep areas
Div.Metrics<-read.csv("DiversityMetrics.Deep.Bootstrapped.csv")
Div.Metrics<-Div.Metrics[Div.Metrics$AREA!=6,]
Sp.Richness<-read.csv("Sp.Richness.Deep.Bootstrapped.csv")
Sp.Richness<-Sp.Richness[Sp.Richness$AREA!=6,]
deepDat<-cbind(Div.Metrics,Sp.Richness)
deepwDat<-deepDat[,c(1:6,10)]

shallowDat$AREA<-as.factor(shallowDat$AREA)
deepDat$AREA<-as.factor(deepDat$AREA)

##Boxplots Alpha Diversity Shallow Areas (exp H'):
sp_box1 <- ggplot(data=shallowDat, aes(AREA, y=Eff_Num_Sp)) + 
  geom_boxplot() + theme_boxplot() + xlab("Area (West <-> East)") +
  ylab("Alpha Diversity (exp H') - Shallow areas") +
  xlim("9","8","7","6","5","4","3","2","1") + 
  #  scale_fill_manual(values=barcolor) + ylim(0,0.5) +
  theme(legend.position="none", plot.background=element_blank(),
        axis.text.x=element_text(size=15),
        plot.title=element_text(colour="black", size=12,
                                hjust=0.04, vjust=0.5))
sp_box1

##Boxplots Alpha Diversity Deep Areas (exp H'):
sp_box2 <- ggplot(data=deepDat, aes(AREA, y=Eff_Num_Sp)) + 
  geom_boxplot() + theme_boxplot() + xlab("Area (West <-> East)") +
  ylab("Alpha Diversity (exp H') - Deep Areas") +
  xlim("5","4","3","2","1") +
  #  scale_fill_manual(values=barcolor) + ylim(0,0.5) +
  theme(legend.position="none", plot.background=element_blank(),
        axis.text.x=element_text(size=15),
        plot.title=element_text(colour="black", size=12,
                                hjust=0.04, vjust=0.5))
sp_box2

##Boxplots Species Richness shallow areas:
sp_box3 <- ggplot(data=shallowDat, aes(AREA, y=Sp_rich)) + 
  geom_boxplot() + theme_boxplot() + xlab("Area (West <-> East)") +
  ylab("Species Richness - Shallow Areas") +
  xlim("9","8","7","6","5","4","3","2","1") + 
  #  scale_fill_manual(values=barcolor) + ylim(0,0.5) +
  theme(legend.position="none", plot.background=element_blank(),
        axis.text.x=element_text(size=15),
        plot.title=element_text(colour="black", size=12,
                                hjust=0.04, vjust=0.5))
sp_box3


##Boxplots Species Richness Deep areas:
sp_box4 <- ggplot(data=deepDat, aes(AREA, y=Sp_rich)) + 
  geom_boxplot() + theme_boxplot() + xlab("Area (West <-> East)") +
  ylab("Species Richness - Deep Areas") +
  xlim("5","4","3","2","1") + 
  #  scale_fill_manual(values=barcolor) + ylim(0,0.5) +
  theme(legend.position="none", plot.background=element_blank(),
        axis.text.x=element_text(size=15),
        plot.title=element_text(colour="black", size=12,
                                hjust=0.04, vjust=0.5))
sp_box4


##Boxplots Inverse Simpson shallow areas:
sp_box5 <- ggplot(data=shallowDat, aes(AREA, y=Invsimp)) + 
  geom_boxplot() + theme_boxplot() + xlab("Area (West <-> East)") +
  ylab("Inverse Simpson - Shallow Areas") +
  xlim("9","8","7","6","5","4","3","2","1") + 
  #  scale_fill_manual(values=barcolor) + ylim(0,0.5) +
  theme(legend.position="none", plot.background=element_blank(),
        axis.text.x=element_text(size=15),
        plot.title=element_text(colour="black", size=12,
                                hjust=0.04, vjust=0.5))
sp_box5


##Boxplots Inverse Simpson Deep areas:
sp_box6 <- ggplot(data=deepDat, aes(AREA, y=Invsimp)) + 
  geom_boxplot() + theme_boxplot() + xlab("Area (West <-> East)")+
  ylab("Inverse Simpson - Deep Areas")+
  xlim("5","4","3","2","1")+ 
  #  scale_fill_manual(values=barcolor) + ylim(0,0.5) +
  theme(legend.position="none", plot.background=element_blank(),
        axis.text.x=element_text(size=15),
        plot.title=element_text(colour="black", size=12,
                                hjust=0.04, vjust=0.5))
sp_box6
```

3: Mean alpha diversity boxplots across years between areas  
```{r, echo=FALSE, fig.height=4, fig.width=7,fig.cap="Alpha diversity (exp H') estimated for shallow areas (50-150m). Based on boostrap sampling (n=1000)."}
#{r sp_box1,fig.width=4,fig.height=3,echo=FALSE,message=FALSE,include=TRUE,fig.cap="Diversity#"}

sp_box1
```

```{r, echo=FALSE, fig.height=4, fig.width=7,fig.cap="Alpha Diversity (exp H') estimated for deep areas (>150-300m). Based on boostrap sampling (n=1000)."}
#{r sp_box1,fig.width=4,fig.height=3,echo=FALSE,message=FALSE,include=TRUE,fig.cap="Diversity#"}

sp_box2
```


4: Mean beta diversity boxplots across year between areas   
5: Functional complementarity figure    
6: NMDS for community composition between areas    


```{r, eval=FALSE, echo=FALSE, fig.height=4, fig.width=7,fig.cap="Species richness estimated for shallow areas (50-150m). Based on boostrap sampling (n=1000)."}
#{r sp_box1,fig.width=4,fig.height=3,echo=FALSE,message=FALSE,include=TRUE,fig.cap="Diversity#"}

sp_box3
```

```{r, eval=FALSE, echo=FALSE, fig.height=4, fig.width=7,fig.cap="Species richness estimated for deep areas (>150-300m). Based on boostrap sampling (n=1000)."}
#{r sp_box1,fig.width=4,fig.height=3,echo=FALSE,message=FALSE,include=TRUE,fig.cap="Diversity#"}

sp_box4
```

```{r, eval=FALSE, echo=FALSE, fig.height=4, fig.width=7,fig.cap="Inverse Simpson's diversity estimated for shallow areas (50-150m). Based on boostrap sampling (n=1000)."}
#{r sp_box1,fig.width=4,fig.height=3,echo=FALSE,message=FALSE,include=TRUE,fig.cap="Diversity#"}

sp_box5
```

```{r fig6, eval=FALSE, echo=FALSE, fig.height=4, fig.width=7,fig.cap="Inverse Simpson's diversity estimated for deep areas (>150-300m). Based on boostrap sampling (n=1000)."}
#{r sp_box1,fig.width=4,fig.height=3,echo=FALSE,message=FALSE,include=TRUE,fig.cap="Diversity#"}

sp_box6
```



### Tables:
1: Bottom depths and temperatures for each area    



\pagebreak

## Time series of diversity metrics for 2nd paper?

```{r, echo=FALSE, eval=FALSE}
# Calculate diversity metrics for shallower areas (50-150m)
Div_SpCPUEArea <- meanCPUE %>%
                  filter(Area!="Total") %>%
                  group_by(Area, Year) %>% 
                  mutate(SW_Div = diversity(Mean.totalDensity, index="shannon"),
                         Exp_A_Div = exp(SW_Div)) %>%  # this is alpha diversity
                  ungroup() %>%
                  group_by(Year) %>%
                  mutate(G_Div = diversity(Mean.totalDensity, index="shannon"),
                         Exp_G_Div = exp(G_Div),
                         Exp_B_Div = (Exp_G_Div/Exp_A_Div)) %>%   # calculate beta diversity (gamma = alpha * beta)
                  ungroup() %>%
                  group_by(Area, Year) %>%
                  mutate(Simp_Div = diversity(Mean.totalDensity, index="simpson"), 
                         InvSimp = diversity(Mean.totalDensity,index="inv")) %>%
                  ungroup %>%
                  arrange(Area, Year)
              
dat <- Div_SpCPUEArea
dat$Area <- as.factor(dat$Area)
datAREA <- sort(as.numeric(as.character(unique(dat$Area))))
datYEAR <- sort(unique(dat$Year))
```


```{r, eval=FALSE, echo=FALSE}
# Calculate diversity metrics for deeper areas (151-300m)
Div_SpCPUEDeep <- deepCPUE %>%
                  filter(Area!="Total") %>%
                  mutate_each(funs(as.character), Area) %>%
                  group_by(Area, Year) %>% 
                  mutate(SW_Div = diversity(Mean.totalDensity, index="shannon"),
                         Exp_A_Div = exp(SW_Div)) %>%  # this is alpha diversity
                  ungroup() %>%
                  group_by(Year) %>%
                  mutate(G_Div = diversity(Mean.totalDensity, index="shannon"),
                         Exp_G_Div = exp(G_Div),
                         Exp_B_Div = (Exp_G_Div/Exp_A_Div)) %>%   # calculate beta diversity (gamma = alpha * beta)
                  ungroup() %>%
                  group_by(Area, Year) %>%
                  mutate(Simp_Div = diversity(Mean.totalDensity, index="simpson"), 
                         InvSimp = diversity(Mean.totalDensity,index="inv")) %>%
                  ungroup %>%
                  arrange(Area, Year)

datDeep <- Div_SpCPUEDeep
datDeep$Area <- as.factor(datDeep$Area)
AREA <- sort(as.numeric(as.character(unique(datDeep$Area))))
YEAR <- sort(unique(datDeep$Year))
```

```{r, eval=FALSE, echo=FALSE, fig.cap="Time series of Alpha diversity for shallow areas (50-150m).", fig.height=4, fig.width=7}
#Plot Alpha Diversity Shallow Areas "exp(Shannon-Wiener)" ie: effective # of species
line_colors <- c("black","black","red","red","red","black","black","black","black")
area_breaks <- c("1","2","3","4","5","6","7","8","9")

Eff_Sp <- Plot_area_time(df=Div_SpCPUEArea, y=Div_SpCPUEArea$Exp_A_Div, 
                         ylabel="Alpha Diversity (exp H')-Shallow Areas")
Eff_Sp
```

```{r, eval=FALSE, echo=FALSE, message=FALSE, include=FALSE}
# Alpha Diversity Shallow Areas exp(H'):
# Calculate and plot least squares trend in each area and portfolio metrics.
vals <- NULL
for(j in 1:length(datAREA)){
  A <- lm(Exp_A_Div~Year,data=dat[dat$Area == datAREA[j] & dat$Year > 1989,]) #,weights = inv.var )
  B <- lm(Exp_A_Div~1,data=dat[dat$Area == datAREA[j] & dat$Year > 1989,]) #,weights = inv.var )
  vals <- rbind(vals,c(datAREA[j],
                       coef(summary(A))["Year",c("Estimate","Std. Error")],
                       coef(summary(B))[1,c("Estimate","Std. Error")],
                       var(A$residuals),
                       sd(A$residuals)))
}
vals <- data.frame(vals)
colnames(vals) <- c("Area","Trend","SE.trend","Grand.w.mean","Grand.w.mean.se","Var","SD")
vals$CV  <- vals$SD / vals$Grand.w.mean 
dat.2 <- vals
```

```{r, eval=FALSE, echo=FALSE, fig.height=4, fig.width=7}
space_plot(df=dat.2,NAME='exp(H)')
```

```{r, eval=FALSE, fig.cap="Time series of Alpha diversity for deep areas (>150-300m).",echo=FALSE, fig.height=4, fig.width=7}
#Plot Alpha Diversity Deep Areas "exp(Shannon-Wiener)" ie: effective # of species
line_colors <- c("red","red","black","black","black")
area_breaks <- c("1","2","3","4","5")

Eff_Sp_dp <- Plot_area_time(df=Div_SpCPUEDeep, y=Div_SpCPUEDeep$Exp_A_Div, 
                            ylabel="Alpha Diversity (exp H')-Deep Areas")
Eff_Sp_dp
```

```{r, eval=FALSE, echo=FALSE, message=FALSE, include=FALSE}
# Alpha Diversity Deep Areas exp(H'):
# Calculate and plot least squares trend in each area and portfolio metrics.
vals <- NULL
for(j in 1:length(AREA)){
  A <- lm(Exp_A_Div~Year,data=datDeep[dat$Area == AREA[j] & datDeep$Year > 1989,]) #,weights = inv.var )
  B <- lm(Exp_A_Div~1,data=datDeep[datDeep$Area == AREA[j] & datDeep$Year > 1989,]) #,weights = inv.var )
  vals <- rbind(vals,c(AREA[j],
                       coef(summary(A))["Year",c("Estimate","Std. Error")],
                       coef(summary(B))[1,c("Estimate","Std. Error")],
                       var(A$residuals),
                       sd(A$residuals)))
  
}
vals <- data.frame(vals)
colnames(vals) <- c("Area","Trend","SE.trend","Grand.w.mean","Grand.w.mean.se","Var","SD")
vals$CV  <- vals$SD / vals$Grand.w.mean 
dat.2 <- vals
```

```{r,eval=FALSE,  echo=FALSE, fig.height=4, fig.width=7}
space_plot(df=dat.2,NAME='exp(H)')
```

   
```{r, eval=FALSE, fig.cap="Time series of Beta diversity for shallow areas (50-150m).",echo=FALSE, fig.height=4, fig.width=7}
#Beta Diversity Shallow Areas "(Exp_G_Div/Exp_A_Div)":
line_colors <- c("black","black","red","red","red","black","black","black","black",
                 "black","black")
area_breaks <- c("1","2","3","4","5","6","7","8","9")

Bdiv <- Plot_area_time(df=Div_SpCPUEArea, y=Div_SpCPUEArea$Exp_B_Div,
                       ylabel="Beta Diversity-Shallow Areas")
Bdiv
```


```{r, eval=FALSE, fig.cap="Time series of Beta diversity for deep areas (>150-300m).",echo=FALSE, fig.height=4, fig.width=7}
#Beta Diversity Deep Areas "(Exp_G_Div/Exp_A_Div)": 
line_colors <- c("red","red","black","black","black")
area_breaks <- c("1","2","3","4","5")

Bdiv_dp <- Plot_area_time(df=Div_SpCPUEDeep, y=Div_SpCPUEDeep$Exp_B_Div,
                       ylabel="Beta Diversity-Deep Areas")
Bdiv_dp
```



```{r, eval=FALSE, echo=FALSE}
# Calculate Species Richness for Deep Areas: 
Div_SpOccArea <- meanOcc %>%
                 mutate_each(funs(as.numeric), Year) %>%
                 rename(Area=area) %>%
                 filter(Area!="Total") %>%
                 group_by(Area, Year) %>% 
                 mutate(SW_Div = diversity(Mean.avgPresence, index="shannon"),
                        Exp_A_Div = exp(SW_Div), # this is alpha diversity
                        Sp_Rich = sum(Mean.avgPresence)) %>%  
                 ungroup() %>%
                 group_by(Year) %>%
                 mutate(G_Div = diversity(Mean.avgPresence, index="shannon"),
                        Exp_G_Div = exp(G_Div),
                        Exp_B_Div = (Exp_G_Div/Exp_A_Div)) %>%   # calculate beta diversity (gamma = alpha * beta)
                 ungroup() 
              
dat_occ <-Div_SpOccArea
dat_occ$Year <- as.numeric(dat_occ$Year)
dat_occ$Area <- as.factor(dat_occ$Area)
datAREA <- sort(as.numeric(as.character(unique(dat_occ$Area))))
datYEAR <- sort(unique(dat_occ$Year))
```

```{r, eval=FALSE, echo=FALSE}
#Calculate Species Richness for Deep Areas:
Div_SpOccDeep <- deepOCC %>%
                 mutate_each(funs(as.numeric), Year) %>%
                 rename(Area=area) %>%
                 filter(Area!="Total") %>%
                 group_by(Area, Year) %>% 
                 mutate(SW_Div = diversity(Mean.avgPresence, index="shannon"),
                        Exp_A_Div = exp(SW_Div), 
                        Sp_Rich = sum(Mean.avgPresence)) %>%  # this is alpha diversity
                 ungroup() %>%
                 group_by(Year) %>%
                 mutate(G_Div = diversity(Mean.avgPresence, index="shannon"),
                        Exp_G_Div = exp(G_Div),
                        Exp_B_Div = (Exp_G_Div/Exp_A_Div)) %>%   # calculate beta diversity (gamma = alpha * beta)
                 ungroup() 
datDeep_occ <-Div_SpOccDeep
datDeep_occ$Year <- as.numeric(datDeep_occ$Year)
datDeep_occ$Area <- as.factor(datDeep_occ$Area)
AREA <- sort(as.numeric(as.character(unique(datDeep_occ$Area))))
YEAR <- sort(unique(datDeep_occ$Year))
```

```{r fig15, eval=FALSE, echo=FALSE, fig.height=4, fig.width=7}
#Species Richness Shallow Areas:
# Shallow Species Richness
line_colors <- c("black","black","black","black","red","red","red","black","black")
area_breaks <- c("1","2","3","4","5","6","7","8","9")

SpRdiv <- Plot_area_time(df=Div_SpOccArea, y=Div_SpOccArea$Sp_Rich,
                         ylabel="Species Richness-Shallow Areas")
SpRdiv
```

```{r, eval=FALSE, echo=FALSE}  
#Species richness
# Calculate least squares trend in each area and portfolio metrics.
vals <- NULL

for(j in 1:length(datAREA)){
  A <- lm(Sp_Rich~Year,data=dat_occ[dat_occ$Area == datAREA[j] & dat_occ$Year > 1989,]) #,weights = inv.var )
  B <- lm(Sp_Rich~1,data=dat_occ[dat_occ$Area == datAREA[j] & dat_occ$Year > 1989,]) #,weights = inv.var )
  vals <- rbind(vals,c(datAREA[j],
                       coef(summary(A))["Year",c("Estimate","Std. Error")],
                       coef(summary(B))[1,c("Estimate","Std. Error")],
                       var(A$residuals),
                       sd(A$residuals)
                       )
                  )
}
vals <- data.frame(vals)
colnames(vals) <- c("Area","Trend","SE.trend","Grand.w.mean","Grand.w.mean.se","Var","SD")
vals$CV  <- vals$SD / vals$Grand.w.mean 

dat.2 <- vals

space_plot(df=dat.2,NAME="Species Richness")
```


```{r fig17, eval=FALSE, echo=FALSE, fig.height=4, fig.width=7}
#Species richness Deep Areas: 
# Deep Species Richness
line_colors <- c("red","red","black","black","black")
area_breaks <- c("1","2","3","4","5")

SpRdeep <- Plot_area_time(df=Div_SpOccDeep, y=Div_SpOccDeep$Sp_Rich, 
                          ylabel="Species Richness-Deep Areas")
SpRdeep
```

```{r fig18, eval=FALSE, echo=FALSE, fig.height=4, fig.width=7}
#Species richness
# Calculate least squares trend in each area and portfolio metrics.
vals <- NULL

for(j in 1:length(AREA)){
  A <- lm(Sp_Rich~Year,data=datDeep_occ[datDeep_occ$Area == AREA[j] & datDeep_occ$Year > 1989,]) #,weights = inv.var )
  B <- lm(Sp_Rich~1,data=datDeep_occ[datDeep_occ$Area == AREA[j] & datDeep_occ$Year > 1989,]) #,weights = inv.var )
  vals <- rbind(vals,c(AREA[j],
                       coef(summary(A))["Year",c("Estimate","Std. Error")],
                       coef(summary(B))[1,c("Estimate","Std. Error")],
                       var(A$residuals),
                       sd(A$residuals)
                       )
                  )
}
vals <- data.frame(vals)
colnames(vals) <- c("Area","Trend","SE.trend","Grand.w.mean","Grand.w.mean.se","Var","SD")
vals$CV  <- vals$SD / vals$Grand.w.mean 

dat.2 <- vals

space_plot(df=dat.2,NAME="Species Richness")
```

\pagebreak

### Discussion 
1) EVOS magnitude vs. magnitude of other perturbations
2) EVOS in the context of other perturbations (climate change, etc)


\pagebreak

### References

Anderson, P. J., and J. F. Piatt. 1999. Community reorganization in the Gulf of Alaska following ocean climate        regime shift. Marine Ecology Progress Series 189:117-123.

Chesson, P., R. L. E. Gebauer, S. Schwinning, N. Huntly, K. Wiegand, M. S. K. Ernest, A. Sher, A. Novoplansky, j. F.   Weltzin. 2004. Resource pulses, species interactions, and diversity maintenance in arid and semi-arid               environments. Oecologia 141:236-253.

Gaichas, S., and R. C. Francis. 2008. Network models for ecosystem-based fishery analysis: a review of concepts and   application to the Gulf of alaska marine food web. Canadian Journal of Fisheries and Aquatic Science 65:1965-1982.

Gaichas, S. K., K. Y. Aydin, R. C. Francis, and J. Post. 2011. What drives dynamics in the Gulf of Alaska?            Integrating hypotheses of species, fishing, and climate relationships using ecosystem modeling. Canadian Journal    of Fisheries and Aquatic Sciences 68(9):1553-1578.

Hare, S. R., and N. J. Mantua. 2000. Empirical evidence for North Pacific regime shifts in 1977 and 1989. Progress    in Oceanography 47(2–4):103-145.

Hollowed, A. B., S. R. Hare, and Wooster, W. S. . 2001. Pacific basin climate variability and patterns of Northeast   Pacific marine fish production. Progress in Oceanography 49:257-282.

Hollowed, A. B., C. D. Wilson, P. J. Stabeno, and S. A. Salo. 2007. Effect of ocean conditions on the cross-shelf     distribution of walleye pollock (Theragra chalcogramma) and capelin (Malloutus villosus). Fisheries Oceanography    16(2):142-154.

Incardona, J. P., and coauthors. 2015. Very low embryonic crude oil exposures cause lasting cardiac defects in        salmon and herring. Scientific Reports 5:13499.

Jost, L. 2007. PARTITIONING DIVERSITY INTO INDEPENDENT ALPHA AND BETA COMPONENTS. Ecology 88(10):2427-2439.
  Lagerloef, G. 1983. Topographically controlled flow around a deep trough transecting the shelf off Kodiak Island,   Alaska. Journal of Physical Oceanography 13:139–146.

Logerwell, E. A., P. J. Stabeno, C. Wilson, and A. B. Hollowed. 2007. The effect of oceanographic variability and     interspecific competition on juvenile pollock and capelin distributions of the Gulf of Alaska Shelf. Deep Sea       Research II 54:2849-2686.

Ono, K., and coauthors. 2015. Space-time investigation of the effects of fishing on fish populations. Ecological      Applications.

Schindler, D. E., J. B. Armstrong, and T. E. Reed. 2015. The portfolio concept in ecology and evolution. Frontiers    in Ecology and the Environment 13(5):257-263.

Schindler, D. E., and coauthors. 2010. Population diversity and the portfolio effect in an exploited species. Nature   465(7298):609-612.

Shelton, A. O., J. T. Thorson, E. J. Ward, and B. E. Feist. 2014. Spatial semiparametric models improve estimates of   species abundance and distribution. Canadian Journal of Fisheries and Aquatic Sciences 71(11):1655-1666.

Smith, E. P., D. R. Orvos, and J. Cairns Jr. 1993. Impact Assessment Using the Before-After-Control-Impact (BACI)     Model: Concerns and Comments. Canadian Journal of Fisheries and Aquatic Sciences 50(3):627-637.

Stachura, M. M., and coauthors. 2014. Linking Northeast Pacific recruitment synchrony to environmental variability.   Fisheries Oceanography 23(5):389-408.

von Szalay, P. G., N. W. Raring, F. R. Shaw, M. E. Wilkins, and M. H. Martin. 2010 Data report: 2009 Gulf of Alaska   bottom trawl survey. , volume 208. U.S. Dep. Commer. , Seattle, WA.

Walline, P. D., C. D. Wilson, A. B. Hollowed, and S. C. Stienessen. 2012. Short-term effects of commercial fishing    on the distribution and abundance of walleye pollock (Theragra chalcogramma). Canadian Journal of Fisheries and     Aquatic Science 69:354-368.

Wilson, J. B. 2011. The twelve theories of co-existence in plant communities: the doubtful, the important and the     unexplored. Journal of Vegetation Science 22(1):184-195.


