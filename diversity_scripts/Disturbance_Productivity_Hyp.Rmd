---
title: "Disturbance_Productivity_Hypothesis"
author: "Rachael E. Blake"
date: "January 31, 2017"
output:
  pdf_document: default
  html_document: default
---

```{r, include=FALSE, echo=FALSE, results='hide'}
# Load packages
library(vegan) ; library(mvnormtest) ; library(plyr)
library(tidyverse) ; library(forcats) ; library(gridExtra)
library(ggplot2) ; library(psych) ; library(mgcv)
library(AICcmodavg) ; library(visreg)

```

```{r, include=FALSE, echo=FALSE, results='hide'}
# source the diversity metrics csv file
div_met <- read.csv("../diversity-data/DiversityMetrics.Shallow.Bootstrapped.Final.csv")
#head(div_met)

```

```{r, include=FALSE, echo=FALSE, results='hide'}
# source the fishing pressure calculation script
source("../diversity_scripts/Fishing_Pressure_calc.r")

# want the catch_sum dataframe from here
#head(catch_sum)

```

```{r, echo=FALSE, results='hide'}
# source the chlorophyll a calculation script

```

```{r, echo=FALSE}
#######################################
### MAKE MY OWN THEME TO SAVE LINES OF CODE
theme_boxplot <- function(base_size = 12){
  theme_bw(base_size) %+replace%
    theme(legend.key.size=unit(13,"points"),
          legend.text=element_text(size=I(11)),
          legend.key=element_blank(),
          legend.title=element_blank(),
          #legend.position="none",
          plot.margin=unit(c(0.75,1,0.75,1), "cm"), # respectively: top, right, bottom, left; refers to margin *outside* labels; default is c(1,1,0.5,0.5)
          panel.border=element_blank(),
          panel.spacing=unit(0,"lines"),
          axis.ticks.length=unit(1,"mm"),
          axis.text.x = element_text(margin=margin(5,0,0,0)),
          axis.text.y = element_text(margin=margin(0,5,0,0)),
          axis.text=element_text(size=11),
          axis.title.x=element_text(size=13, margin=margin(15,0,0,0)), 
          axis.title.y=element_text(size=13, angle=90, margin=margin(0,15,0,0)), 
          panel.grid.major=element_blank(),
          panel.grid.minor=element_blank(),
          strip.text.x=element_text(size=14),
          strip.background=element_rect(colour='black', fill='white'),
          #axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'),
          axis.line = element_line(colour = 'black', size=0.5, linetype='solid')
          )
}

```


# Fishing Pressure effects on Diversity Metrics
```{r, echo=FALSE, results='hide'}
# clean the data
catch_sum2 <- catch_sum %>%
              dplyr::rename(Catch_area = final.OLE,
                            Year = year) %>%
              select(Catch_area, Year, met_ton_km2) %>%
              arrange(Catch_area, Year)

div_met2 <- div_met %>%
            rename(Year = YEAR) %>%
            mutate(Catch_area = plyr::mapvalues(AREA, c("1","2","3","4","5","6","7","8","9","10"), 
                                                c("Prince William Sound","Prince William Sound",
                                                  "Prince William Sound","Cook Inlet","Cook Inlet",
                                                  "Kodiak","Kodiak","Kodiak","Kodiak","Alaska Peninsula")))

# make one large dataframe
dist_df <- merge(div_met2, catch_sum2, all.x=T)

# filter for complete cases
dist_df <- dist_df %>% filter(complete.cases(.))

# average to catch area for each year...
dist_df_cat_ar <- dist_df %>%
                  select(-AREA, -Simp, -Invsimp) %>%
                  group_by(Catch_area, Year) %>%
                  summarize(Eff_Num_Sp_ca = mean(Eff_Num_Sp),
                            Sp_rich_ca = mean(Sp_rich),
                            Exp_B_Div_ca = mean(Exp_B_Div),
                            met_ton_km2_ca = mean(met_ton_km2)) %>%
                  ungroup() %>%
                  arrange(Catch_area, Year)
           
```

###with Linear fits
```{r, echo=FALSE, include=FALSE}
# visualizing some data
#pairs.panels(dist_df[,-c(1:3)],smooth=F,density=T,ellipses=F,lm=T,digits=3,scale=T)

lmfit1 <- lm(met_ton_km2_ca~Sp_rich_ca, data=dist_df_cat_ar)  # lm() fit 

div_plot1 <- ggplot(dist_df_cat_ar, aes(x=met_ton_km2_ca, y=Sp_rich_ca, color=Catch_area)) + geom_point() +
             stat_smooth(method="lm", col="blue") + ylab("Species Richness") + 
             xlab("Fishing Pressure (metric tonnes km-2)") + 
             theme(legend.position = "top") +
             labs(title=paste("Adj R^2 =",signif(summary(lmfit1)$adj.r.squared, 5),
                              #"Intercept =",signif(lmfit1$coef[[1]],5 ),
                              #" Slope =",signif(lmfit1$coef[[2]], 5),
                              " p =",signif(summary(lmfit1)$coef[2,4], 5)))

anova(lmfit1) # anova table of above lm() fit

```

```{r, echo=FALSE, include=FALSE}
# visualizing some data

lmfit2 <- lm(met_ton_km2_ca~Eff_Num_Sp_ca, data=dist_df_cat_ar)  # lm() fit 

div_plot2 <- ggplot(dist_df_cat_ar, aes(x=met_ton_km2_ca, y=Eff_Num_Sp_ca, color=Catch_area)) + geom_point() +
             stat_smooth(method="lm", col="blue") + ylab("Effective # of Species") +
             xlab("Fishing Pressure (metric tonnes km-2)") + 
             theme(legend.position = "top") +
             labs(title=paste("Adj R^2 =",signif(summary(lmfit2)$adj.r.squared, 5),
                              #"Intercept =",signif(lmfit2$coef[[1]],5 ),
                              #" Slope =",signif(lmfit2$coef[[2]], 5),
                              " p =",signif(summary(lmfit2)$coef[2,4], 5)))

anova(lmfit2) # anova table of above lm() fit

```

```{r, echo=FALSE, include=FALSE}
# visualizing some data

lmfit3 <- lm(met_ton_km2_ca~Exp_B_Div_ca, data=dist_df_cat_ar)  # lm() fit 

div_plot3 <- ggplot(dist_df_cat_ar, aes(x=met_ton_km2_ca, y=Exp_B_Div_ca, color=Catch_area)) + geom_point() +
             stat_smooth(method="lm", col="blue") + ylab("Beta Diversity ") + 
             xlab("Fishing Pressure (metric tonnes km-2)") + 
             theme(legend.position = "top") +
             labs(title=paste("Adj R^2 =", signif(summary(lmfit3)$adj.r.squared, 5),
                              #"Intercept =",signif(lmfit3$coef[[1]],5 ),
                              #" Slope =",signif(lmfit3$coef[[2]], 5),
                              " p =",signif(summary(lmfit3)$coef[2,4], 5)))

anova(lmfit3) # anova table of above lm() fit

```

```{r, echo=FALSE, fig.height=9, fig.width=10}
# arranging above plots
grid.arrange(div_plot1, div_plot2, div_plot3, ncol=2, nrow=2)

```

###with Loess fits
```{r, echo=FALSE, fig.height=9, fig.width=10}
div_plotA <- ggplot(dist_df_cat_ar, aes(x=met_ton_km2_ca, y=Sp_rich_ca, color=Catch_area)) + geom_point() +
             stat_smooth(method="loess", col="blue") + ylab("Species Richness") + 
             theme(legend.position = "top") +
             xlab("Fishing Pressure (metric tonnes km-2)")

div_plotB <- ggplot(dist_df_cat_ar, aes(x=met_ton_km2_ca, y=Eff_Num_Sp_ca, color=Catch_area)) + geom_point() +
             stat_smooth(method="loess", col="blue") + ylab("Effective # of Species") +
             theme(legend.position = "top") +
             xlab("Fishing Pressure (metric tonnes km-2)") 

div_plotC <- ggplot(dist_df_cat_ar, aes(x=met_ton_km2_ca, y=Exp_B_Div_ca, color=Catch_area)) + geom_point() +
             stat_smooth(method="loess", col="blue") + ylab("Beta Diversity ") + 
             theme(legend.position = "top") +
             xlab("Fishing Pressure (metric tonnes km-2)")

grid.arrange(div_plotA, div_plotB, div_plotC, ncol=2, nrow=2)

```

###With GAM fits
```{r, echo=FALSE}
# Species Richness 
#assumes normally distributed data 
gam1 <- gam(Sp_rich~met_ton_km2, data=dist_df, family=gaussian) # essentially equal to glm()

gam1a <- gam(Sp_rich~s(met_ton_km2, k=1), data=dist_df, family=gaussian) 

gam1b <- gam(Sp_rich~s(met_ton_km2, k=2), data=dist_df, family=gaussian) 

gam1c <- gam(Sp_rich~s(met_ton_km2, k=4), data=dist_df, family=gaussian) 

gam1d <- gam(Sp_rich~s(met_ton_km2, k=40), data=dist_df, family=gaussian) 

gam1e <- gam(Sp_rich~s(met_ton_km2, k=45), data=dist_df, family=gaussian) 

#summary(gam1)
#summary(gam1c)

plot(gam1a, pages=1, residuals=TRUE, shade=T)
plot(gam1b, pages=1, residuals=TRUE, shade=T)

gam.check(gam1b)

AIC(gam1, gam1a, gam1b, gam1c, gam1d, gam1e)

# ggplot


```

```{r}
# Alpha Diversity
gam2 <- gam(Eff_Num_Sp~met_ton_km2, data=dist_df, family=gaussian)  # essentially equal to glm()

gam2a <- gam(Eff_Num_Sp~s(met_ton_km2, k=1), data=dist_df, family=gaussian)

gam2b <- gam(Eff_Num_Sp~s(met_ton_km2, k=2), data=dist_df, family=gaussian)

gam2c <- gam(Eff_Num_Sp~s(met_ton_km2, k=4), data=dist_df, family=gaussian)

gam2d <- gam(Eff_Num_Sp~s(met_ton_km2, k=45), data=dist_df, family=gaussian)

plot(gam2b, pages=1, residuals=TRUE, shade=T)

#summary(gam2) ; summary(gam2a)
AIC(gam2, gam2a, gam2b, gam2c, gam2d)

# ggplot
# use plot = FALSE to get plot data from visreg without plotting
plotdata2 <- visreg(gam2b, type="contrast", plot=FALSE)

# The output from visreg is a list of the same length as the number of 'x' variables,
#   so we use ldply to pick the objects we want from the each list part and make a dataframe: 
smooths2 <- data.frame(Variable = plotdata2$meta$x, 
                       x=plotdata2$fit[[plotdata2$meta$x]], 
                       smooth=plotdata2$fit$visregFit, 
                       lower=plotdata2$fit$visregLwr, 
                       upper=plotdata2$fit$visregUpr)

resid2 <- data.frame(Variable=plotdata2$meta$x,
                     x=plotdata2$res[[plotdata2$meta$x]],
                     y=plotdata2$res$visregRes)

# The ggplot:
gam2_plot <- ggplot(smooths2, aes(x, smooth)) + 
             geom_line() + theme_boxplot() +
             geom_line(aes(y=lower), linetype="dashed") + 
             geom_line(aes(y=upper), linetype="dashed") #+
             #geom_point(data=resid2, aes(x, y)) +

gam2_plot

```

```{r}
# Beta Diversity
gam3 <- gam(Exp_B_Div~met_ton_km2, data=dist_df, family=gaussian)  # essentially equal to glm()

gam3a <- gam(Exp_B_Div~s(met_ton_km2, k=1), data=dist_df, family=gaussian)

gam3b <- gam(Exp_B_Div~s(met_ton_km2, k=2), data=dist_df, family=gaussian)

gam3c <- gam(Exp_B_Div~s(met_ton_km2, k=4), data=dist_df, family=gaussian)

gam3d <- gam(Exp_B_Div~s(met_ton_km2, k=45), data=dist_df, family=gaussian)

plot(gam3b, pages=1, shade=T)

#summary(gam3) ; summary(gam3a)
AIC(gam3, gam3a, gam3b, gam3c, gam3d)

# ggplot
# use plot = FALSE to get plot data from visreg without plotting
plotdata3 <- visreg(gam3b, type="contrast", plot=FALSE)

# The output from visreg is a list of the same length as the number of 'x' variables,
#   so we use ldply to pick the objects we want from the each list part and make a dataframe: 
smooths3 <- data.frame(Variable = plotdata3$meta$x, 
                       x=plotdata3$fit[[plotdata3$meta$x]], 
                       smooth=plotdata3$fit$visregFit, 
                       lower=plotdata3$fit$visregLwr, 
                       upper=plotdata3$fit$visregUpr)

resid3 <- data.frame(Variable=plotdata3$meta$x,
                     x=plotdata3$res[[plotdata3$meta$x]],
                     y=plotdata3$res$visregRes)

# The ggplot:
gam3_plot <- ggplot(smooths3, aes(x, smooth)) + 
             geom_line() + theme_boxplot() +
             geom_line(aes(y=lower), linetype="dashed") + 
             geom_line(aes(y=upper), linetype="dashed") #+
             #geom_point(data=resid3, aes(x, y)) +

gam3_plot

```



