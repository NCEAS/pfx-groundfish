---
title: "Spatial-Temporal-Turnover"
author: "Colette Ward & Rachael Blake"
date: "October 5, 2016"
output: html_document
---

```{r}
library(httr)
library(vegan)
library(mvnormtest)
library(plyr)
library(tidyverse)
library(forcats)
```


```{r}

# Here we are trying to create figures like Mellin et al. 2014 Fig. 2 (Temporal turnover vs Spatial turnover)


# Bray spatial: use abundance data

# Simpson spatial: use occurrence data

# for both Bray & Simpson, calculate spatial turnover using data averaged across all years


# packages of potential interest: 
# synchrony includes function to calculate distance between sites(?)

```



```{r,  include=FALSE, echo=FALSE, results='hide'}
# load & prep look-up table of common names
URL_common <- "https://drive.google.com/uc?export=download&id=0B1XbkXxdfD7ubzIzdURzanhfZnc" # this is "trawl_species_control_file.csv"
common_Get <- GET(URL_common)
common_1 <- content(common_Get, as='text')
common <- read.csv(file=textConnection(common_1),stringsAsFactors=FALSE,head=TRUE)

common1 <- common %>%
  select(database.name, common.name) %>%
  dplyr::rename(Species = database.name)

for (i in 1:nrow(common1)) { # add common names for Sebastes 1 & 2
  if(common1$Species[i] == "Dusky.and.Dark.Rockfish") {common1$common.name[i] <- "Sebastes 1"}
  if(common1$Species[i] == "Rougheye.and.Blackspotted.Rockfish") {common1$common.name[i] <- "Sebastes 2"}
}
```


```{r,  include=FALSE, echo=FALSE, results='hide'}

# load mean annual CPUE data:

# 1. Shallow areas:
URL_shallowCPUEArea <- "https://drive.google.com/uc?export=download&id=0By1iaulIAI-uYzBOUFRtZklmX0U" # new data for shallow areas
shallowCPUEArea_Get <- GET(URL_shallowCPUEArea)
shallowCPUEArea_1 <- content(shallowCPUEArea_Get, as='text')
shallowCPUEArea <- read.csv(file=textConnection(shallowCPUEArea_1),stringsAsFactors=FALSE,head=TRUE)
shallowCPUEArea2 <- left_join(shallowCPUEArea, common1, by = "Species") # merge common names onto SPCPUEArea




# 2. Deep areas:
URL_deepCPUEArea <- "https://drive.google.com/uc?export=download&id=0By1iaulIAI-uVF9VWnNPX3Z3S3c"
deepCPUEArea_Get <- GET(URL_deepCPUEArea)
deepCPUEArea_1 <- content(deepCPUEArea_Get, as='text')
deepCPUEArea <- read.csv(file=textConnection(deepCPUEArea_1),stringsAsFactors=FALSE,head=TRUE)
deepCPUEArea2 <- left_join(deepCPUEArea, common1, by = "Species") # merge in common names

```


```{r}
# prep data for dissimilarity calcs
# start with Shallow areas, Bray spatial

# need mean community composition matrix for each area (mean of 1984-2015)
shallow_Spatial_mat <- shallowCPUEArea2 %>%
  select(common.name, Mean.totalDensity, area, year) %>%
  filter(area != "Total") %>%
  group_by(area, common.name) %>%
  summarize(temporal.mean = mean(Mean.totalDensity)) %>%
  ungroup() %>%
  spread(common.name, temporal.mean) %>% # make each species a column
  select(-area)
  # then spread as needed by vegan for dissimilarity matrix calcs: sites as rows, species as columns
#View(shallow_Spatial_mat)


# Bray
shallow.dis.bray.wisc <- vegdist(wisconsin(shallow_Spatial_mat), "bray", upper = TRUE, lower=TRUE); shallow.dis.bray.wisc # with Wisconsin transformation
#shallow.dis.bray.hell <- vegdist(decostand(shallow_Spatial_mat, "hell"), "bray"); shallow.dis.bray.hell # with Hellinger transformation

shallow_mean_spatial <- colSums(as.data.frame(as.matrix(shallow.dis.bray.wisc)))/8


# calculate community dissimilarities
# 1. pairwise between separate communities across space (plot dissimilarity vs distance)
# 2. then group adjacent sites (within X km) and repeat
# 3. then group at larger spatial scale (within Y km, or [Westernmost, Kodiak, Easternmost]) and repeat

# 4. plot bray-curtis temporal dissimilarity (at lag-1) vs spatial turnover


# Temporal turnover:
# start with 1984 vs 2015
# calculate for each site

temporal_func <- function(your_df, area_number){
                 Temp_Mat <- your_df %>%
                             select(area, year, Mean.totalDensity, common.name) %>%
                             filter(area != "Total", year %in% c("1984", "2015")) %>%
                             spread(common.name, Mean.totalDensity) %>%
                             filter(area == area_number) %>% select(-area, -year)
                 
                 Wisc_Temp_Mat <- wisconsin(Temp_Mat)
                 
                 return(Wisc_Temp_Mat)
}

#View(shallow_ends)

temporal_func(shallowCPUEArea2, 1) #testing the function

areas_shallow <- c(1:9)
areas_deep <- c(10:14)

shallow_mats <- lapply(areas_shallow, FUN = temporal_func, your_df=shallowCPUEArea2)   # produces Wisconsin-transformed matrices for each study area

bray_shallow_mats <- lapply(shallow_mats, FUN=vegdist, method="bray")   # get Bray-Curtis dissimilarities





# now, calculate temporal turnover between '84 & '15 for each area

```

```{r, echo=FALSE}
#bray_shallow_mats, shallow_mean_spatial

is.vector(shallow_mean_spatial) #T
is.list(bray_shallow_mats) #T

#bray_shallow_mats1 <- unlist(bray_shallow_mats)
shallow_for_plotting <- data.frame(shallow_mean_spatial, unlist(bray_shallow_mats))

str(shallow_for_plotting)

ggplot(shallow_for_plotting, aes(x = shallow_mean_spatial, y = unlist.bray_shallow_mats.)) +
  geom_point() +
  theme_bw()


```

