---
title: "Local vs Regional Stability of Gulf of Alaksa Groundfish Assemblages"
author: "Colette Ward"
date: "July 12, 2016"
output: pdf_document
---


```{r, include=FALSE, echo=FALSE, results='hide'}
# Load packages
library(httr)
library(plyr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(gridExtra)

```


```{r,  include=FALSE, echo=FALSE, results='hide'}
# load & prep look-up table of common names
URL_common <- "https://drive.google.com/uc?export=download&id=0B1XbkXxdfD7ubzIzdURzanhfZnc" # this is "trawl_species_control_file.csv"
common_Get <- GET(URL_common)
common_1 <- content(common_Get, as='text')
common <- read.csv(file=textConnection(common_1),stringsAsFactors=FALSE,head=TRUE)

common1 <- common %>%
  select(database.name, common.name) %>%
  rename(Species = database.name)
for (i in 1:nrow(common1)) { # add common names for Sebastes 1 & 2
  if(common1$Species[i] == "Dusky.and.Dark.Rockfish") {common1$common.name[i] <- "Sebastes 1"}
  if(common1$Species[i] == "Rougheye.and.Blackspotted.Rockfish") {common1$common.name[i] <- "Sebastes 2"}
}
```


```{r,  include=FALSE, echo=FALSE, results='hide'}
# load mean annual CPUE data for Shallow Areas:
#URL_shallowCPUEArea <- "https://drive.google.com/uc?export=download&id=0By1iaulIAI-uYzBOUFRtZklmX0U" # new data for shallow areas
#shallowCPUEArea_Get <- GET(URL_shallowCPUEArea)
#shallowCPUEArea_1 <- content(shallowCPUEArea_Get, as='text')
#shallowCPUEArea <- read.csv(file=textConnection(shallowCPUEArea_1),stringsAsFactors=FALSE,head=TRUE)
#View(shallowCPUEArea)


setwd("~/Google Drive/GoA project/pfx-groundfish/diversity-data") # set this to the path on your local machine
shallowCPUEArea <- read.csv("All_sp_index_meanCPUEByArea.csv", header = T, stringsAsFactors = FALSE)


shallowCPUEArea2 <- left_join(shallowCPUEArea, common1, by = "Species") %>% # merge common names onto SPCPUEArea
  select(area, Mean.totalDensity, SD.totalDensity, year, Species, common.name) %>%
  filter(area != "8") %>% # remove Ole's area 8
  mutate(area = revalue(area, c("9"="8", "10"="9", "11"="10"))) %>% # renumber (old = new) shallow areas to account for splitting area 7 into 7, 8, 9 but removing 8
  mutate(area = revalue(area, c("Total" = "Region")))

```

```{r,  include=FALSE, echo=FALSE, results='hide'}
# load mean annual CPUE for Deep areas:
URL_deepCPUEArea <- "https://drive.google.com/uc?export=download&id=0By1iaulIAI-uVF9VWnNPX3Z3S3c"
deepCPUEArea_Get <- GET(URL_deepCPUEArea)
deepCPUEArea_1 <- content(deepCPUEArea_Get, as='text')
deepCPUEArea <- read.csv(file=textConnection(deepCPUEArea_1),stringsAsFactors=FALSE,head=TRUE)
#View(deepCPUEArea)

deepCPUEArea2 <- left_join(deepCPUEArea, common1, by = "Species") %>% # merge in common names
  select(area, Mean.totalDensity, SD.totalDensity, year, Species, common.name) %>%
  mutate(area = revalue(area, c("1"="11", "2"="12", "3"="14", "4"="15", "5"="13", "Total" = "Region")))

```

To address local vs regional community stability we can compare CVs of total CPUE between local communities and the regional metacommunity.
The regional community does indeed show greater stability than local communities. Note that y-axis scales differ - deep areas are generally less stable than shallow areas.  
**The magnitude of the portfolio effect can be assessed from the ratio of mean local CV / regional CV (ie the increase in stability that arises from spatial (beta) diversity; values >1 indicate a stabilizing effect): the ratio is ~2.3 for shallow areas and ~1.4 for deep areas.** (I'm not sure the difference between effect size in shallow and deep is meaningful, it may arise because we have more local patches for shallow areas.)  
[If anyone wants to make these plots prettier, please do :) ]

```{r, echo=F, fig.height=3.5, fig.width=8}

# Shallow areas:
CV_shallow <- shallowCPUEArea2 %>% 
  group_by(area, year) %>%
  summarise(total = sum(Mean.totalDensity)) %>%
  ungroup() %>%
  
  group_by(area) %>%
  summarise(CV = sd(total) / mean(total)) %>%
  ungroup()

# mean CV of shallow local areas
# CV_shallow %>%
#   filter(area != "Total") %>%
#   summarise(mean = mean(CV), sd = sd(CV))
# 0.171/0.073 # ratio of mean local / regional = 2.342 for shallow areas


# plot on a log scale
CV_shallow_plot <- ggplot(data=CV_shallow, aes(x=area, y = CV)) + 
  geom_point(aes(y = CV), size=5) +
  
  theme(panel.background = element_blank(),
        axis.line.x = element_line(color="black"),
        axis.line.y = element_line(color="black"),
        axis.text.x = element_text(margin=margin(5,0,0,0), size=12), 
        axis.text.y = element_text(margin=margin(0,5,0,0), size=12),
        axis.title.x=element_text(size=12, margin=margin(15,0,0,0)),
        axis.title.y=element_text(size=12, angle=90, margin=margin(0,15,0,0)),
        plot.title = element_text(size=18)) +
  
  scale_x_discrete(limits=c(1:10, "Region")) +

  scale_y_log10(breaks = c(0.07, 0.08, 0.09, 0.1, 0.15, 0.2)) +
  
  labs(x = "Area", y = "CV (Total CPUE)", title = "Shallow Areas")



##############################

# Deep areas:
CV_deep <- deepCPUEArea2 %>% 
  group_by(area, year) %>%
  summarise(total = sum(Mean.totalDensity)) %>%
  ungroup() %>%
  
  group_by(area) %>%
  summarise(CV = sd(total) / mean(total)) %>%
  ungroup()

# mean CV of deep local areas
# CV_deep %>%
#   filter(area != "Total") %>%
#   summarise(mean = mean(CV), sd = sd(CV))
# 0.253/0.187 # ratio of mean local / regional = 1.353 for deep areas


# plot on a log scale
CV_deep_plot <- ggplot(data=CV_deep, aes(x=area, y = CV)) + 
  geom_point(aes(y = CV), size=5) +
  
  theme(panel.background = element_blank(),
        axis.line.x = element_line(color="black"),
        axis.line.y = element_line(color="black"),
        axis.text.x = element_text(margin=margin(5,0,0,0), size=12), 
        axis.text.y = element_text(margin=margin(0,5,0,0), size=12),
        axis.title.x=element_text(size=12, margin=margin(15,0,0,0)),
        axis.title.y=element_text(size=12, angle=90, margin=margin(0,15,0,0)),
        plot.title = element_text(size=18)) +
  
  scale_y_log10(breaks = c(0.15, 0.2, 0.25, 0.3, 0.35, 0.4)) +
  
  labs(x = "Area", y = "CV (Total CPUE)", title = "Deep Areas")



grid.arrange(CV_shallow_plot, CV_deep_plot, ncol=2)

```

Although we can compare local and regional community stability using CVs alone, here we calculate metrics from Wang & Loreau (2014) to help us think about mechanisms underlying this result.
The following uses formulas from Wang & Loreau's (2014) Supp Mat (i.e. for the case where biomass varies within and between local communities).
```{r,  include=FALSE, echo=FALSE, results='hide'}

# CONSIDER WHETHER TO LOG-TRANSFORME SPECIES FIRST

# note: for applying this to our spatial groupings, your_df should have a column called spatialGrouping, which contains the grouping code

WangLoreau_func <- function(your_df){
  
  #shallowAreas_list <- split(your_df, f = your_df$area) # create a list of dataframes (one df for each local area)
  shallowAreas_list <- split(your_df, f = your_df$spatialGrouping) # create a list of dataframes (one df for each spatial group)

  # nomenclature for the following calculations:
  # i, h = local community i (and h)
  # j, k, l = species j, k, l
  # j_i = species j in local community i
  # u = mean
  # w = variance or covariance
  # w_kk_i = variance of each species k within local community i
  # w_kl_i = covariance between species k and l within local community i
  # w_ii = variance (of total community CPUE) for each local community i
  # w_ih = covariance (of total community CPUE) between local communities i & h
  # rho = temporal Synchrony; inverse is Beta (temporal Asynchrony)


  A_list <- list(); B_list <- list(); C_list <- list(); D_list <- list(); E_list <- list(); F_list <- list()
  covMatrix_i_list <- list(); w_kk_i_list <- list(); rho_species_i_list <- list(); CV_i_list <- list()

  
  
  for(i in seq_along(shallowAreas_list)) {
    
  # 1. Calculate averaged species variability (C_list[[i]]$CV_species_i_squared):
  
  # calculate local community-level stuff
    A_list[[i]] <- shallowAreas_list[[i]] %>%
      group_by(year) %>%
      summarise(annual_total_i = sum(Mean.totalDensity)) %>%
      ungroup() %>%
      summarise(var_i = var(annual_total_i),
                stDev_i = sqrt(var(annual_total_i)),
                u_i = mean(annual_total_i)) # mean total community biomass (across all years) for local community i
    
  
  # calculate species-level stuff
    B_list[[i]] <- shallowAreas_list[[i]] %>%
      group_by(Species) %>%
      summarise(u_j_i = mean(Mean.totalDensity), # mean biomass (across all years) of species j in local community i
                CV_j_i_squared = var(Mean.totalDensity) / (u_j_i)^2 , # CV of species j in local community i. Note the usual formula for CV is squared
                CV_species_j_i = u_j_i / A_list[[i]]$u_i * CV_j_i_squared) %>% # CV of species in local community i
      ungroup()
  
  
  # calculate averaged species variability
    C_list[[i]] <- B_list[[i]] %>%
      summarise(CV_species_i_squared = sum(CV_species_j_i))
  
  
  ##############################
  # 2. Calculate species asynchrony WITHIN local areas (rho_species_i_list[[i]]):
    D_list[[i]] <- shallowAreas_list[[i]] %>%
      select(year, Mean.totalDensity, Species) %>%
      spread(Species, Mean.totalDensity) %>%
      select(-year)
    
    
    covMatrix_i_list[[i]] <- cov(D_list[[i]]) # create the covariance matrix
    
    
    w_kk_i_list[[i]] <- diag(covMatrix_i_list[[i]]) # extract diagonals of the covariance matrix. these are temporal variance of each species k within local community i
    
    
    covMatrix_i_list[[i]][upper.tri(covMatrix_i_list[[i]], diag = TRUE)] <- NA # for each local community i, keep one copy of all the non-diagonals. these are w_kl_i
    E_list[[i]] <- as.data.frame(covMatrix_i_list[[i]])
    
    
    F_list[[i]] <- E_list[[i]] %>%
      summarise(sum_w_kl_i = sum(E_list[[i]][,1:53], na.rm = T)) # for each local community i, find the sum of all w_kl_i. calc has been checked
    
    
    rho_species_i_list[[i]] <- F_list[[i]]$sum_w_kl_i / ((sum(sqrt(w_kk_i_list[[i]][1:53])))^2)
  
  
  ##############################
  # 3. Calculate Variability of local community i (CV_i_list[[i]])
    CV_i_list[[i]] <- C_list[[i]]$CV_species_i_squared * rho_species_i_list[[i]]
   #CV_i_list[[i]] <- (C_list[[i]]$CV_species_i_squared * rho_species_i_list[[i]])^2 # It's not clear whether this should be squared. If not squred, returns a negative value when within-patch species synchrony is negative.
      
  # CHECK WHETHER LOCAL COMMUNITY VARIABILITY CORRELATES WITH SIZE (AREA) OF LOCAL COMMUNITY (IE DO LARGER AREAS SHOW MORE VARIABILITY?)
  
  
  ##############################
  # 4. Calculate Alpha variability (local community variability weighed for local community biomass; alpha_CV_list[[i]])
    u_m <- sum(A_list[[i]]$u_i)
    alpha_CV <- (sum(A_list[[i]]$u_i / u_m * CV_i_list[[i]] ))^2 # It's not clear whether this should be squared.
    
    }

  
  ##############################
  # 5. Calculate Beta variability (spatial synchrony; rho)
  # note I'm replacing Wang & Loreau's local patch i & j notation with i & h, to avoid confusion with species j

  shallowCPUEArea3 <- your_df %>%  
    filter(area != "Total") %>%
    group_by(area, year) %>%
    summarise(ann_tot_i = sum(Mean.totalDensity)) %>%
    ungroup() %>%
    spread(area, ann_tot_i) %>%
    select(-year)
  
  
  covMatrix_m <- cov(shallowCPUEArea3) # create the covariance matrix
  
  w_ii <- diag(covMatrix_m) # extract diagonals of the covariance matrix. returns a vector. this is temporal variance of total community CPUE, within each local community.
  
  covMatrix_m[upper.tri(covMatrix_m, diag = TRUE)] <- NA # keep one copy of all the non-diagonals. These are w_ih (temporal covariance of total community biomass between local patches i & h). NB it would be nice to bring in species-level information here, to prevent dominant species from driving the result.
  w_ih <- as.data.frame(covMatrix_m)
  
  summed_w_ih <-w_ih %>% summarise(sum_w_ih = sum(w_ih[,1:9], na.rm = T)) # find the sum of all w_ih. calc has been checked
  
  rho <- summed_w_ih$sum_w_ih / ((sum(sqrt(w_ii[1:9])))^2) # Wang & Loreau (2014) claim that standardizing for within-patch covariance accounts for spatial uneveness in biomass. Not sure about this.
  Beta1 <- 1 / rho
  

  ##############################
  # 6. Calculate Gamma variability
  
  gamma_CV <- alpha_CV / Beta1
  
  return(gamma_CV)
}



WangLoreau_func(shallowCPUEArea2) # test the function ... result is as expected.
  
```


###Within-patch sums of all between-species covariances. Negative values indicate asynchrony.
```{r, echo=F, fig.height=2.75, fig.width=4}
# F_list
F_df <- data.frame(matrix(NA_real_, nrow = 9, ncol = 2)); 
colsF <- c("Area", "sum_w_kl_i"); colnames(F_df) <- colsF
areaNum <- as.vector(1:9); F_df[,1] <- as.factor(areaNum)

for(i in seq_along(F_list)) {
  F_df[i,2] <- data.frame(as.data.frame(F_list[[i]]$sum_w_kl_i))
}


# plot
cov.within_shallow <- ggplot(data=F_df, aes(x=areaNum, y = sum_w_kl_i)) + 
  geom_point(aes(y = sum_w_kl_i), size=5) +
  
  theme(panel.background = element_blank(),
        axis.line.x = element_line(color="black"),
        axis.line.y = element_line(color="black")) +
  
  scale_x_continuous(breaks = c(1:9)) +
  
  labs(x = "Area", y = "sum_w_kl_i", title = "Shallow Areas")

cov.within_shallow
```


```{r, include=FALSE, echo=FALSE, results='hide'}
# Within-patch species asynchrony:
# rho_species_i_list
rho_sp_df <- data.frame(matrix(NA_real_, nrow = 9, ncol = 2)); 
cols_rho_sp <- c("Area", "rho_species_i"); colnames(rho_sp_df) <- cols_rho_sp
areaNum <- as.vector(1:9); rho_sp_df[,1] <- as.factor(areaNum)

for(i in seq_along(rho_species_i_list)) {
  rho_sp_df[i,2] <- data.frame(as.data.frame(rho_species_i_list[[i]]))
}


# plot
asynch.within <- ggplot(data=rho_sp_df, aes(x=areaNum, y = rho_species_i)) + 
  geom_point(aes(y = rho_species_i), size=5) +
  
  theme(panel.background = element_blank(),
        axis.line.x = element_line(color="black"),
        axis.line.y = element_line(color="black")) +
  
  scale_x_continuous(breaks = c(1:9)) +
  
  labs(x = "Area", y = "rho_species_i")

asynch.within
```


```{r, include=FALSE, echo=FALSE, results='hide'}
# Within-patch variability (ie CVs of total community CPUE within local communities):
# CV_i_list
CV_i_df <- data.frame(matrix(NA_real_, nrow = 9, ncol = 2)); 
cols_CV_i <- c("Area", "CV_i"); colnames(CV_i_df) <- cols_CV_i
areaNum <- as.vector(1:9); CV_i_df[,1] <- as.factor(areaNum)

for(i in seq_along(CV_i_list)) {
  CV_i_df[i,2] <- data.frame(as.data.frame(CV_i_list[[i]]))
}

# plot
CV.within <- ggplot(data=CV_i_df, aes(x=areaNum, y = CV_i)) + 
  geom_point(aes(y = CV_i), size=5) +
  
  theme(panel.background = element_blank(),
        axis.line.x = element_line(color="black"),
        axis.line.y = element_line(color="black")) +
  
  scale_x_continuous(breaks = c(1:9)) +
  
  labs(x = "Area", y = "CV_i")

CV.within
```


###Alpha variability (temporal variability at the local scale (NB weighed for local community biomass)):
```{r}
alpha_CV
```


### Spatial synchrony:
```{r}
rho
```


### Within-patch variance (ie temporal variance of each local area's total community CPUE, within local communities):
```{r}
w_ii
```


### Temporal covariance of total community CPUE between all pairs of local communities. Broadly speaking, local areas 1-6 covary positively with eachother, as do areas 7-9. Areas 1-6 covary negatively with 7-9.
```{r}
w_ih
```


###Beta variability (Multiplicative beta variability, i.e. the degree of spatial asynchrony):
```{r}
Beta1
```


###Gamma variability (temporal variability at the metacommunity scale):
```{r}
gamma_CV
```




```{r}
deepAreas_list <- split(deepCPUEArea2, f = deepCPUEArea2$area) # create a list of dataframes (one df for each local area & total region)
deepAreas_list[[Region]] <- NULL  # remove Regional total from the list

# nomenclature for the following calculations:
# i, h = local community i (and h)
# j, k, l = species j, k, l
# j_i = species j in local community i
# u = mean
# w = variance or covariance
# w_kk_i = variance of each species k within local community i
# w_kl_i = covariance between species k and l within local community i
# w_ii = variance (of total community CPUE) for each local community i
# w_ih = covariance (of total community CPUE) between local communities i & h
# rho = temporal Synchrony; inverse is Beta (temporal Asynchrony)

G_list <- list()

for(i in seq_along(deepAreas_list)) {
  
  # 1. Calculate averaged species variability (C_list[[i]]$CV_species_i_squared):
  
  # calculate local community-level stuff
  G_list[[i]] <- deepAreas_list[[i]] %>%
    group_by(year) %>%
    summarise(annual_total_i = sum(Mean.totalDensity)) %>%
    ungroup() %>%
    summarise(var_i = var(annual_total_i),
              stDev_i = sqrt(var(annual_total_i)),
              u_i = mean(annual_total_i)) # mean total community biomass (across all years) for local community i
}
```

# Calculate Predator / Prey ratios:
```{r, include=FALSE, echo=FALSE, results='hide'}

# Assign predator and prey groupings
topPred <- c("Albatrossia.pectoralis", "Anoplopoma.fimbria", "Atheresthes.stomias", "Bathyraja.aleutica", 
             "Hemilepidotus.jordani", "Hemitripterus.bolini", "Hexagrammos.decagrammus", "Hippoglossus.stenolepis",
             "Myoxocephalus.polyacanthocephalus", "Ophiodon.elongatus", "Raja.binoculata", "Squalus.acanthias", 
             "Oncorhynchus.tshawytscha", "Dusky.and.Dark.Rockfish")

benthicPrey <- 
  
pelagicPrey <-



# assign predator & prey categories to data, then calculate pred/prey ratios
for(i in 1:nrow(shallowCPUEArea2)) {
  if(grepl(paste(topPred, collapse = "|"), shallowCPUEArea2$Species[i])) {shallowCPUEArea2$categ[i] <- "Predator"}
  else{shallowCPUEArea2$categ[i] <- "Prey"}
}
shallowStuff <- shallowCPUEArea2 %>%
  filter(area != "Region") %>%
  group_by(area, year, categ) %>% summarise(sumTotal = sum(Mean.totalDensity)) %>% ungroup() %>%
  spread(categ, sumTotal) %>% # now spread into columns for pred & prey
  mutate(ratio = Predator/Prey) #%>%
  #group_by(area) %>% summarise(meanRatio = mean(ratio), sdRatio = sd(ratio)) %>% ungroup()
#View(shallowStuff)
  


for(i in 1:nrow(deepCPUEArea2)) {
  if(grepl(paste(topPred, collapse = "|"), deepCPUEArea2$Species[i])) {deepCPUEArea2$categ[i] <- "Predator"}
  else{deepCPUEArea2$categ[i] <- "Prey"}
}
deepStuff <- deepCPUEArea2 %>%
  filter(area != "Region") %>%
  group_by(area, year, categ) %>% summarise(sumTotal = sum(Mean.totalDensity)) %>% ungroup() %>%
  spread(categ, sumTotal) %>% # now spread into columns for pred & prey
  mutate(ratio = Predator/Prey) #%>%
  #group_by(area) %>% summarise(meanRatio = mean(ratio), sdRatio = sd(ratio)) %>% ungroup()
#View(deepStuff)


stuff <- full_join(shallowStuff, deepStuff) #%>% mutate(area = as.numeric(area))


# calculate lag-1 differences in Pred/Prey ratios
diffs <- apply( as.matrix(stuff$ratio) , 2 , diff )
dummyRow = c(1); diffs <- as.data.frame(rbind(dummyRow,diffs))  # then add 1 row to start of this vector
colnames(diffs) <- "ratioDiffs"
stuff$ratioDiffs <- diffs$ratioDiffs # paste this vector onto existing stuff df
for(i in 1:nrow(stuff)) {
  if(stuff$year[i] == 1984) {stuff$ratioDiffs[i] <- NA} # remove diff values for 1984 for all areas b/c they're meaningless
}



# Set colors for local areas:
colorsSE <- c("pink", "red", "orange", "yellow", "yellow3", "lightgreen", "green")
colorsS <- c("pink", "red", "orange", "yellow", "yellow3", "lightgreen", "green", "blue", "navy")
colorsD <- c("purple", "lightslateblue", "saddlebrown", "black", "grey")
colorsWest <- c("blue", "navy", "black", "grey")
colorsMid <- c("orange", "yellow", "yellow3", "lightgreen", "green", "purple", "lightslateblue", "saddlebrown")
colors <- c("pink", "red", "orange", "yellow", "yellow3", "lightgreen", "green", "blue", "navy", "purple", "lightslateblue", "saddlebrown", "black", "grey")


years <- unique(sort(stuff$year))


# Plot Predator / Prey ratios over time:
ggplot(data=stuff, aes(x=year, y = ratio, group = area, color = area)) + 
  geom_point(aes(y = ratio), size=5) + geom_line(aes(y = ratio)) +
  theme(panel.background = element_blank(),
        axis.line.x = element_line(color="black"),
        axis.line.y = element_line(color="black")) +
  scale_y_log10(breaks = c(0.1, 0.5, 1, 2, 3)) +
  scale_x_continuous(breaks=c(years), labels=c(years)) +
  labs(x = "Year", y = "Predator / Prey ratio (CPUE)") +
  geom_hline(yintercept= 1) +

  scale_color_manual(name = "Area", 
                     values=setNames(colorsMid, c(3:7,10:12)), 
                     limits=c('3', '4', '5', '6', '7', '10', '11', '12'))
  
  #scale_color_manual(name = "Area", 
                     values=setNames(colorsWest, c(8:9,13:14)), 
                     limits=c('8', '9', '13', '14'))
  
  #scale_color_manual(name = "Area", 
                     values=setNames(colorsSE, 1:7), 
                     limits=c('1', '2', '3', '4', '5', '6', '7'))
  
  #scale_color_manual(name = "Area", 
                     values=setNames(colorsD, 10:14), 
                     limits=c('10', '11', '12', '13', '14'))

  scale_color_manual(name = "Area", 
                     values=setNames(colors, 1:14), 
                     limits=c('1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14'))





# Plot Predator / Prey ratio lag-1 differences over time:
ggplot(data=stuff, aes(x=year, y = ratioDiffs, group = area, color = area)) + 
  geom_point(aes(y = ratioDiffs), size=5) + geom_line(aes(y = ratioDiffs)) +
  theme(panel.background = element_blank(),
        axis.line.x = element_line(color="black"),
        axis.line.y = element_line(color="black")) +
  scale_x_continuous(breaks=c(years), labels=c(years)) +
  labs(x = "Year", y = "Difference (lag-1) Predator / Prey ratio (CPUE)") +
  
  scale_color_manual(name = "Area", 
                     values=setNames(colorsMid, c(3:7,10:12)), 
                     limits=c('3', '4', '5', '6', '7', '10', '11', '12'))
  
  scale_color_manual(name = "Area", 
                     values=setNames(colorsWest, c(8:9,13:14)), 
                     limits=c('8', '9', '13', '14'))
  
  scale_color_manual(name = "Area", 
                     values=setNames(colorsSE, 1:7), 
                     limits=c('1', '2', '3', '4', '5', '6', '7'))

  #scale_color_manual(name = "Area", 
                     values=setNames(colorsS, 1:9), 
                     limits=c('1', '2', '3', '4', '5', '6', '7', '8', '9'))
  
  scale_color_manual(name = "Area", 
                     values=setNames(colorsD, 10:14), 
                     limits=c('10', '11', '12', '13', '14'))

  scale_color_manual(name = "Area", 
                     values=setNames(colors, 1:14), 
                     limits=c('1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14'))



  
  
# Plot Total  Prey CPUE over time:  
ggplot(data=stuff, aes(x=year, y = Prey, group = area, color = area)) + 
  geom_point(aes(y = Prey), size=5) + geom_line(aes(y = Prey)) +
  theme(panel.background = element_blank(),
        axis.line.x = element_line(color="black"),
        axis.line.y = element_line(color="black")) +
  scale_x_continuous(breaks=c(years), labels=c(years)) +
  scale_y_log10(breaks = c(10, 100, 200, 300, 400)) +
  labs(x = "Year", y = "Prey CPUE") +
  
  scale_color_manual(name = "Area", 
                     values=setNames(colorsMid, c(3:7,10:12)), 
                     limits=c('3', '4', '5', '6', '7', '10', '11', '12'))
  
  scale_color_manual(name = "Area", 
                     values=setNames(colorsWest, c(8:9,13:14)), 
                     limits=c('8', '9', '13', '14'))
  
  scale_color_manual(name = "Area", 
                     values=setNames(colorsSE, 1:7), 
                     limits=c('1', '2', '3', '4', '5', '6', '7'))

  scale_color_manual(name = "Area", 
                     values=setNames(colorsS, 1:9), 
                     limits=c('1', '2', '3', '4', '5', '6', '7', '8', '9'))
  
  scale_color_manual(name = "Area", 
                     values=setNames(colorsD, 10:14), 
                     limits=c('10', '11', '12', '13', '14'))

  scale_color_manual(name = "Area", 
                     values=setNames(colors, 1:14), 
                     limits=c('1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14'))



  
  
  
# Plot Total Predator CPUE over time:  
ggplot(data=stuff, aes(x=year, y = Predator, group = area, color = area)) + 
  geom_point(aes(y = Predator), size=5) + geom_line(aes(y = Predator)) +
  theme(panel.background = element_blank(),
        axis.line.x = element_line(color="black"),
        axis.line.y = element_line(color="black")) +
  scale_x_continuous(breaks=c(years), labels=c(years)) +
  scale_y_log10(breaks = c(10, 100, 200, 300, 400)) +
  labs(x = "Year", y = "Predator CPUE") +
  
  scale_color_manual(name = "Area", 
                     values=setNames(colorsMid, c(3:7,10:12)), 
                     limits=c('3', '4', '5', '6', '7', '10', '11', '12'))
  
  scale_color_manual(name = "Area", 
                     values=setNames(colorsWest, c(8:9,13:14)), 
                     limits=c('8', '9', '13', '14'))
  
  scale_color_manual(name = "Area", 
                     values=setNames(colorsSE, 1:7), 
                     limits=c('1', '2', '3', '4', '5', '6', '7'))

  scale_color_manual(name = "Area", 
                     values=setNames(colorsS, 1:9), 
                     limits=c('1', '2', '3', '4', '5', '6', '7', '8', '9'))
  
  scale_color_manual(name = "Area", 
                     values=setNames(colorsD, 10:14), 
                     limits=c('10', '11', '12', '13', '14'))

  scale_color_manual(name = "Area", 
                     values=setNames(colors, 1:14), 
                     limits=c('1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14'))
  
  
  
  
  
  
  
  
  



# Load Mary & Rachael's boxplot theme:
theme_boxplot <- function(base_size = 12){
  theme_bw(base_size)%+replace%
    theme(legend.key.size=unit(12,"points"),
          legend.text=element_text(size=11),
          legend.key=element_blank(),
          legend.title=element_blank(),
          legend.background=element_rect(colour="white", fill="transparent"),
          plot.margin=unit(c(0.5,1,0.5,1), "lines"),  
          panel.border=element_blank(),
          panel.margin=unit(0,"lines"),
          panel.background=element_rect(fill=NA, colour=NA),
          panel.grid.major=element_blank(),
          panel.grid.minor=element_blank(),
          axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'),
          axis.line.y = element_line(colour = 'black', size=0.5, linetype='solid'),
          axis.ticks.length=unit(1,"mm"),
          axis.text.x = element_text(margin=margin(5,0,0,0), size=12), 
          axis.text.y = element_text(margin=margin(0,5,0,0), size=12),
          axis.title.x=element_text(size=12, margin=margin(15,0,0,0)),
          axis.title.y=element_text(size=12, angle=90, margin=margin(0,15,0,0)),
          strip.text.x=element_text(size=12),
          strip.background=element_rect(colour="black", fill='white'))
}


shallow_ratio_boxplot <- ggplot(data=shallowStuff, aes(x = area, y = ratio)) + 
  geom_boxplot() + theme_boxplot() +
  xlab("Area (West <-> East)") + ylab("Predator / Prey ratio (CPUE)") +
  xlim("9", "8", "7", "6", "5", "4", "3", "2", "1") + 
  ylim(0, 3.15) +
  geom_hline(yintercept= 1) +
  theme(plot.background=element_blank(),
        axis.text.x = element_text(size=15))

deep_ratio_boxplot <- ggplot(data=deepStuff, aes(x = area, y = ratio)) + 
  geom_boxplot() + theme_boxplot() +
  xlab("Area (West <-> East)") + ylab("Predator / Prey ratio (CPUE)") +
  xlim("14", "13", "12", "11", "10") + 
  ylim(0, 3.15) +
  geom_hline(yintercept= 1) +
  theme(plot.background=element_blank(),
        axis.text.x = element_text(size=15))
  
grid.arrange(shallow_ratio_boxplot, deep_ratio_boxplot, ncol=2)
  
  
  


# plot mean Arrowtooth CPUE in each area
shallowTot <- shallowCPUEArea2 %>%
  filter(area != "Region") %>% 
  group_by(area, year) %>% summarise(sumTotal = sum(Mean.totalDensity)) %>% ungroup() %>%
  group_by(area) %>% summarise(meanTotal = mean(sumTotal)) %>% ungroup()

#shallowTot <- shallowCPUEArea2 %>%
#  filter(area != "Region") %>% 
#  group_by(area, year) %>% summarise(aftProp = mean(Mean.totalDensity)) %>% ungroup()

shallowATF <- shallowCPUEArea2 %>%
  filter(area != "Region") %>% filter(common.name == "arrowtooth flounder") #%>%
  #group_by(area) %>% summarise(meanATF = mean(Mean.totalDensity)) %>% ungroup()

shallow <- left_join(shallowTot, shallowATF) %>% 
  mutate(area = as.numeric(area), 
         atfProportion = meanATF/meanTotal) # should really do this fraction properly by year, then take means across years

deepTot <- deepCPUEArea2 %>%
  filter(area != "Region") %>% 
  group_by(area, year) %>% summarise(sumTotal = sum(Mean.totalDensity)) %>% ungroup() %>%
  group_by(area) %>% summarise(meanTotal = mean(sumTotal)) %>% ungroup()

deepATF <- deepCPUEArea2 %>%
  filter(area != "Region") %>% filter(common.name == "arrowtooth flounder") #%>%
  #group_by(area) %>% summarise(meanATF = mean(Mean.totalDensity)) %>% ungroup()

deep <- left_join(deepTot, deepATF) %>% 
  mutate(area = as.numeric(area), 
         atfProportion = meanATF/meanTotal) # should really do this fraction properly by year, then take means across years


ATF <- bind_rows(shallow, deep)
for(i in 1:nrow(ATF)) {
  if(ATF$area[i] <= 9) {ATF$depth[i] <- "shallow"}
  if(ATF$area[i] >= 10) {ATF$depth[i] <- "deep"}
}


ggplot(data=ATF, aes(x=area, y = meanATF, color = depth)) + 
  geom_point(aes(y = meanATF), size=5) +
  theme(panel.background = element_blank(),
        axis.line.x = element_line(color="black"),
        axis.line.y = element_line(color="black")) +
  scale_y_log10(breaks = c(50, 100, 150)) +
  labs(x = "Area", y = "Mean Arrowtooth CPUE") +
  scale_x_continuous(breaks = c(1:14))
  #facet_wrap(~ depth)





shallow_ATF_boxplot <- ggplot(data=shallowATF, aes(x = area, y = Mean.totalDensity)) + 
  geom_boxplot() + theme_boxplot() +
  xlab("Area (West <-> East)") + ylab("Arrowtooth CPUE") +
  xlim("9", "8", "7", "6", "5", "4", "3", "2", "1") + 
  scale_y_log10(breaks = c(50, 100, 150, 200, 250, 300)) +
  theme(plot.background=element_blank(),
        axis.text.x = element_text(size=15))

deep_ATF_boxplot <- ggplot(data=deepATF, aes(x = area, y = Mean.totalDensity)) + 
  geom_boxplot() + theme_boxplot() +
  xlab("Area (West <-> East)") + ylab("Arrowtooth CPUE") +
  xlim("14", "13", "12", "11", "10") + 
  scale_y_log10(breaks = c(50, 100, 150, 200, 250, 300)) +
  theme(plot.background=element_blank(),
        axis.text.x = element_text(size=15))
  
grid.arrange(shallow_ATF_boxplot, deep_ATF_boxplot, ncol=2)


# what is the relationship between Arrowtooth CPUE and species richness? over space and over time (within each area and for all areas pooled?)




# plot total CPUE
ggplot(data=ATF, aes(x=area, y = meanTotal, color = depth)) + 
  geom_point(aes(y = meanTotal), size=5) +
  theme(panel.background = element_blank(),
        axis.line.x = element_line(color="black"),
        axis.line.y = element_line(color="black")) +
  scale_y_log10(breaks = c(100, 200, 300)) +
  scale_x_continuous(breaks = c(1:14)) +
  labs(x = "Area", y = "Mean Total CPUE")


# plot fraction of total CPUE in each area this is Arrowtooth
ggplot(data=ATF, aes(x=area, y = atfProportion, color = depth)) + 
  geom_point(aes(y = atfProportion), size=5) +
  theme(panel.background = element_blank(),
        axis.line.x = element_line(color="black"),
        axis.line.y = element_line(color="black")) +
  scale_x_continuous(breaks = c(1:14)) +
  labs(x = "Area", y = "Mean Proportion of Total CPUE from Arrowtooth")










```